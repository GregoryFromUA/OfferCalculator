<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Calculator v.1.2.1</title>
    <style>
        :root {
            --primary: #6200ea;
            --primary-hover: #5000c2;
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-2: #2c2c2c;
            --text: #ffffff;
            --text-sec: #b0b0b0;
            --danger: #cf6679;
            --success: #4caf50;
            --warning: #ff9800;
            --border: #444;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Layout */
        .main-wrapper {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        @media (max-width: 850px) {
            .main-wrapper { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* Controls */
        h3 { margin: 0 0 15px 0; }
        
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: bold;
            transition: 0.2s;
            font-size: 0.9em;
            color: white;
            background: #333;
        }
        button:hover { opacity: 0.9; }
        
        .btn-primary { background: var(--primary); width: 100%; padding: 12px; font-size: 1em; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-icon { padding: 5px 10px; }
        .btn-danger { background: var(--danger); }
        .btn-sec { background: var(--surface-2); border: 1px solid var(--border); }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 5px;
        }
        input:focus { outline: none; border-color: var(--primary); background: #333; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1200px;
        }

        .tab-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-sec);
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.2s;
            font-weight: bold;
            flex-grow: 1;
            text-align: center;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Tab-specific colors */
        #tab_pack.active { background: #2196F3; border-color: #2196F3; }
        #tab_chest.active { background: #FFB300; border-color: #FFB300; }
        #tab_blitz.active { background: #FF5722; border-color: #FF5722; }
        #tab_chain.active { background: #6200ea; border-color: #6200ea; }
        #tab_custom.active { background: #4CAF50; border-color: #4CAF50; }

        /* Tab-specific active element colors */
        body[data-current-tab="pack"] .mode-toggle button.active,
        body[data-current-tab="pack"] .btn-primary { background: #2196F3; }

        body[data-current-tab="chest"] .mode-toggle button.active,
        body[data-current-tab="chest"] .btn-primary { background: #FFB300; }

        body[data-current-tab="blitz"] .mode-toggle button.active,
        body[data-current-tab="blitz"] .btn-primary { background: #FF5722; }

        body[data-current-tab="chain"] .slot-type-toggle button.active,
        body[data-current-tab="chain"] .btn-primary { background: #6200ea; }

        body[data-current-tab="custom"] .mode-toggle button.active,
        body[data-current-tab="custom"] .btn-primary { background: #4CAF50; }

        /* Inputs */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-sec); font-size: 0.85em; }
        
        /* Price Buttons */
        .price-presets {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .price-tag {
            background: #333;
            padding: 10px 5px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid transparent;
            text-align: center;
            user-select: none;
        }
        .price-tag:hover { border-color: var(--secondary); color: var(--secondary); background: #444; }
        .price-tag:active { transform: scale(0.95); }

        /* Result */
        .result-card { position: sticky; top: 20px; text-align: center; border: 2px solid transparent; }
        .result-main { font-size: 3.5em; font-weight: 800; margin: 10px 0; line-height: 1; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; }
        .res-row { display: flex; justify-content: space-between; padding: 12px 0; border-top: 1px solid #444; }

        /* History */
        .history-container { width: 100%; max-width: 1200px; overflow-x: auto; margin-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; font-size: 0.9em; }
        th { background: #252525; color: var(--text-sec); }
        tr:hover { background: #2c2c2c; }

        /* Modals */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
        .overlay.open { display: flex; }
        .modal { background: var(--surface); padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .checklist-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; }
        
        /* Colors */
        .val-bad { border-color: var(--danger); }
        .val-bad .result-main, .text-bad { color: var(--danger); }
        .val-bad .badge { background: var(--danger); color: white; }
        .val-ok { border-color: var(--warning); }
        .val-ok .result-main, .text-ok { color: var(--warning); }
        .val-ok .badge { background: var(--warning); color: black; }
        .val-good { border-color: var(--success); }
        .val-good .result-main, .text-good { color: var(--success); }
        .val-good .badge { background: var(--success); color: white; }
        .val-epic { border-color: #00e5ff; }
        .val-epic .result-main, .text-epic { color: #00e5ff; }
        .val-epic .badge { background: #00e5ff; color: black; }
        .val-legendary { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .val-legendary .result-main, .text-legendary { color: #ffd700; }
        .val-legendary .badge { background: #ffd700; color: black; }

        .tools-bar { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; margin-bottom: 10px; }
        .tools-bar a { color: var(--text-sec); text-decoration: underline; font-size: 0.9em; cursor: pointer; margin-right: 15px; }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 5px;
            background: var(--surface-2);
            padding: 3px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .mode-toggle button {
            flex: 1;
            padding: 8px 16px;
            background: transparent;
            color: var(--text-sec);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .mode-toggle button.active {
            background: var(--primary);
            color: white;
        }

        /* Reverse Mode */
        .reverse-section {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }
        .reverse-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .reverse-fields { grid-template-columns: 1fr; }
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: var(--surface-2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        .progress-bar-fill.complete {
            background: linear-gradient(90deg, var(--success), #00e5ff);
        }
        .progress-bar-fill.over {
            background: linear-gradient(90deg, #ffd700, #ff9800);
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .progress-target {
            color: var(--text-sec);
        }
        .progress-current {
            font-weight: bold;
            color: white;
        }
        .progress-remaining {
            color: var(--warning);
        }

        /* Chain Offer Styles */
        .chain-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .slot-card {
            background: var(--surface-2);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: 0.2s;
        }
        .slot-card:hover {
            border-color: var(--primary);
        }
        .slot-card.free-slot {
            border-left: 4px solid var(--success);
        }
        .slot-card.paid-slot {
            border-left: 4px solid var(--warning);
        }
        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-right: 35px;
        }
        .slot-type-toggle {
            display: flex;
            gap: 5px;
            background: var(--surface);
            padding: 3px;
            border-radius: 6px;
        }
        .slot-type-toggle button {
            padding: 6px 12px;
            background: transparent;
            color: var(--text-sec);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: 0.2s;
        }
        .slot-type-toggle button.active {
            background: var(--primary);
            color: white;
        }
        .slot-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .slot-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .slot-item select, .slot-item input {
            background: var(--surface);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .slot-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
            background: var(--surface);
            border-radius: 6px;
            font-size: 0.85em;
        }
        .slot-metric {
            text-align: center;
        }
        .slot-metric-label {
            color: var(--text-sec);
            font-size: 0.8em;
            margin-bottom: 3px;
        }
        .slot-metric-value {
            font-weight: bold;
            color: white;
        }
        .btn-delete-slot {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: 0.2s;
        }
        .btn-delete-slot:hover {
            transform: scale(1.15);
            background: #d32f2f;
        }
        .chain-result-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--primary);
        }
        .chain-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        .chain-summary-item {
            padding: 15px;
            background: var(--surface-2);
            border-radius: 8px;
            text-align: center;
        }
        .chain-summary-label {
            color: var(--text-sec);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .chain-summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body>

    <!-- Tools -->
    <div class="tools-bar">
        <div>
            <a id="btnOpenRes">‚öô –†–µ—Å—É—Ä—Å—ã –∏ –¶–µ–Ω—ã</a>
            <a id="btnExport">üíæ –≠–∫—Å–ø–æ—Ä—Ç</a>
            <a id="btnImportTrigger">üìÇ –ò–º–ø–æ—Ä—Ç</a>
            <input type="file" id="importFile" style="display:none">
        </div>
        <div>Offer Calculator v.1.2.1</div>
    </div>

    <!-- Tabs (No Onclick Here!) -->
    <div class="tabs" id="tabsContainer">
        <div class="tab-btn active" data-tab="pack" id="tab_pack">üì¶ Packs</div>
        <div class="tab-btn" data-tab="chest" id="tab_chest">üéÅ Chests</div>
        <div class="tab-btn" data-tab="blitz" id="tab_blitz">‚ö° Blitz</div>
        <div class="tab-btn" data-tab="chain" id="tab_chain">‚õì Chain</div>
        <div class="tab-btn" data-tab="custom" id="tab_custom">‚öôÔ∏è Custom</div>
    </div>

    <div class="main-wrapper" id="mainWrapper">
        <!-- Left: Config -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="tabTitle">Pack Config</h3>
                <button class="btn-sec btn-icon" id="btnOpenTabConfig">‚úè –ü–æ–ª—è</button>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button id="modeNormal" class="active">üìä –û–±—ã—á–Ω—ã–π</button>
                <button id="modeReverse">üéØ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –û—Ñ–µ—Ä–∞</label>
                <input type="text" id="offerName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>

            <!-- Reverse Mode Section -->
            <div class="reverse-section" id="reverseSection" style="display:none;">
                <label style="font-weight:bold; color:var(--warning); display:block; margin-bottom:10px;">üéØ –¶–ï–õ–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò</label>
                <div class="reverse-fields">
                    <div class="input-group">
                        <label>Multiplier (X)</label>
                        <input type="number" id="targetMulti" placeholder="5" min="1" step="1" value="5">
                    </div>
                    <div class="input-group">
                        <label>ROI %</label>
                        <input type="number" id="targetROI" placeholder="400" min="0" step="1" value="400">
                    </div>
                    <div class="input-group">
                        <label>Discount %</label>
                        <input type="number" id="targetDiscount" placeholder="80" min="0" max="99" step="1" value="80">
                    </div>
                </div>
                <div style="margin-top:10px; padding:10px; background:#1a1a1a; border-radius:6px; text-align:center;">
                    <div style="font-size:0.85em; color:var(--text-sec);">–¢—Ä–µ–±—É–µ–º–∞—è –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                    <div style="font-size:1.8em; font-weight:bold; color:var(--warning); margin-top:5px;" id="targetBaseValue">$0.00</div>
                </div>
            </div>
            
            <div id="dynamicInputs" class="input-grid"></div>

            <div style="margin-top: 15px; padding-top:10px; border-top: 1px solid #333;">
                <label style="display:flex; align-items:center; cursor:pointer; gap: 10px;">
                    <input type="checkbox" id="cb_noads" style="width:20px; height:20px;">
                    <span style="font-weight:bold;">NO ADS</span>
                    <span style="color:#666; font-size:0.9em;">(Base: +$<span id="lbl_noads_price">10</span>)</span>
                </label>
            </div>

            <!-- Progress Bar (Reverse Mode) -->
            <div class="progress-container" id="progressContainer" style="display:none;">
                <div style="font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span>üìà –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∫–∏</span>
                    <span id="progressPercent" style="color:var(--warning);">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressFill" style="width:0%;">
                        <span id="progressText"></span>
                    </div>
                </div>
                <div class="progress-info">
                    <div class="progress-target">
                        –¶–µ–ª—å: <span id="progressTargetVal" style="font-weight:bold;">$0.00</span>
                    </div>
                    <div class="progress-current">
                        –¢–µ–∫—É—â–∞—è: <span id="progressCurrentVal">$0.00</span>
                    </div>
                    <div class="progress-remaining" id="progressRemainingDiv">
                        –û—Å—Ç–∞–ª–æ—Å—å: <span id="progressRemainingVal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Price Section -->
            <div style="margin-top: 25px; background: #252525; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <label style="color: var(--secondary); font-weight: bold; display:block; margin-bottom:5px;">–¶–ï–ù–ê –ü–ê–ö–ê ($)</label>
                
                <input type="number" id="offerPrice" step="0.5" min="0.49" value="0.99" style="font-size: 1.4em; font-weight: bold; color: var(--warning);">
                
                <!-- Price Presets (No Onclick!) -->
                <div class="price-presets" id="pricePresetsContainer">
                    <div class="price-tag" data-val="0.99">$0.99</div>
                    <div class="price-tag" data-val="1.99">$1.99</div>
                    <div class="price-tag" data-val="2.99">$2.99</div>
                    <div class="price-tag" data-val="3.99">$3.99</div>
                    <div class="price-tag" data-val="4.99">$4.99</div>
                    <div class="price-tag" data-val="7.99">$7.99</div>
                    <div class="price-tag" data-val="9.99">$9.99</div>
                    <div class="price-tag" data-val="14.99">$14.99</div>
                    <div class="price-tag" data-val="19.99">$19.99</div>
                    <div class="price-tag" data-val="24.99">$24.99</div>
                </div>
            </div>
        </div>

        <!-- Right: Result -->
        <div class="card result-card val-ok" id="resCard">
            <div class="badge" id="resBadge">Ready</div>
            <div style="color: #888; font-size: 0.9em; margin-top:5px;">Multiplier (X Value)</div>
            <div class="result-main" id="resMulti">0x</div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;">
                <span id="resRoi">0%</span> MORE
            </div>
            <div class="res-row">
                <span>Base Value</span>
                <span id="resBase" style="font-weight:bold; font-size:1.2em;">$0.00</span>
            </div>
            <div class="res-row">
                <span>Discount</span>
                <span id="resDisc" style="font-weight:bold;">0%</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" id="btnCopyResult">üìã Copy</button>
                <button class="btn-primary" id="btnAddToHistory">‚¨á –°—Ä–∞–≤–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- History -->
    <div class="history-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</h3>
            <button class="btn-sec btn-icon" id="btnClearHistory">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–°–æ—Å—Ç–∞–≤</th>
                    <th>Base Value</th>
                    <th>Discount</th>
                    <th>ROI</th>
                    <th>Multiplier</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <!-- Modals -->
    <div class="overlay" id="modalResources">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>–ë–∞–∑–æ–≤—ã–µ –¶–µ–Ω—ã</h3>
                <button class="btn-icon" id="btnCloseResModal">‚úñ</button>
            </div>
            <div id="resourceListEditor"></div>
            <div style="margin-top:20px; padding-top:10px; border-top:1px solid #444;">
                <h4>–ù–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å</h4>
                <input type="text" id="newResName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin-bottom:5px;">
                <input type="number" id="newResPrice" placeholder="–¶–µ–Ω–∞ ($)" step="0.01" style="margin-bottom:10px;">
                <button class="btn-primary" id="btnAddNewRes">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-sec" id="btnResetDefaults" style="margin-top:10px; width:100%;">–°–±—Ä–æ—Å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="modalTabConfig">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>–ü–æ–ª—è –≤–∫–ª–∞–¥–∫–∏</h3>
                <button class="btn-icon" id="btnCloseTabModal">‚úñ</button>
            </div>
            <div id="tabFieldList"></div>
            <button class="btn-primary" style="margin-top:15px;" id="btnSaveTabConfig">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- CONFIGURATION ---
            var defaultResources = [
                { id: 'gem', name: 'Gem', price: 0.0125 },
                { id: 'skip', name: 'SkipIt', price: 0.3 },
                { id: 'tnt', name: 'TNT', price: 0.06 },
                { id: 'nitro', name: 'Nitro', price: 0.03 },
                { id: 's_chest', name: 'Small Chest', price: 0.75 },
                { id: 'b_chest', name: 'Big Chest', price: 3.75 },
                { id: 'noads', name: 'No Ads', price: 10.0, isSpecial: true } 
            ];

            var defaultTabConfig = {
                'pack': ['gem', 'skip'],
                'chest': ['gem', 'skip'], // Changed to Gems and Skipits for chest calculator
                'blitz': ['tnt', 'nitro'],
                'chain': [], // Chain tab uses different UI
                'custom': ['gem', 'skip', 'tnt', 'nitro', 's_chest', 'b_chest']
            };

            var appData = {
                resources: JSON.parse(JSON.stringify(defaultResources)),
                tabConfig: JSON.parse(JSON.stringify(defaultTabConfig)),
                history: [],
                currentTab: 'pack',
                calcMode: 'normal', // 'normal' or 'reverse'
                chainSlots: [], // Array of slot objects for chain tab
                chestConfig: {  // Configuration for chest calculator
                    name: '',
                    price: 0.99,
                    items: []
                }
            };

            // Store original mainWrapper HTML for restoration
            var originalMainWrapperHTML = '';

            // --- INITIALIZATION ---

            function init() {
                // Save original HTML before any modifications
                originalMainWrapperHTML = document.getElementById('mainWrapper').innerHTML;

                safeLoad();
                switchTab(appData.currentTab);
                updateNoAdsLabel();
                renderHistory();
                bindEvents();

                // Restore calc mode
                if(appData.calcMode === 'reverse') {
                    setCalcMode('reverse');
                }
            }

            function bindEvents() {
                // Top Bar
                document.getElementById('btnOpenRes').addEventListener('click', openResourceSettings);
                document.getElementById('btnExport').addEventListener('click', exportData);
                document.getElementById('btnImportTrigger').addEventListener('click', function() { document.getElementById('importFile').click(); });
                document.getElementById('importFile').addEventListener('change', function() { importData(this); });

                // Mode Toggle (only for normal tabs)
                var modeNormal = document.getElementById('modeNormal');
                var modeReverse = document.getElementById('modeReverse');
                if(modeNormal) modeNormal.addEventListener('click', function() { setCalcMode('normal'); });
                if(modeReverse) modeReverse.addEventListener('click', function() { setCalcMode('reverse'); });

                // Reverse Mode Inputs (only for normal tabs)
                var targetMulti = document.getElementById('targetMulti');
                var targetROI = document.getElementById('targetROI');
                var targetDiscount = document.getElementById('targetDiscount');
                if(targetMulti) targetMulti.addEventListener('input', onTargetMultiChange);
                if(targetROI) targetROI.addEventListener('input', onTargetROIChange);
                if(targetDiscount) targetDiscount.addEventListener('input', onTargetDiscountChange);

                // Tabs
                document.querySelectorAll('.tab-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var tab = this.getAttribute('data-tab');
                        switchTab(tab);
                    });
                });

                // Config Buttons (only for normal tabs)
                var btnOpenTabConfig = document.getElementById('btnOpenTabConfig');
                var cb_noads = document.getElementById('cb_noads');
                var offerPrice = document.getElementById('offerPrice');
                if(btnOpenTabConfig) btnOpenTabConfig.addEventListener('click', openTabConfig);
                if(cb_noads) cb_noads.addEventListener('change', calculate);
                if(offerPrice) offerPrice.addEventListener('input', calculate);

                // Price Presets (only for normal tabs)
                var pricePresetsContainer = document.getElementById('pricePresetsContainer');
                if(pricePresetsContainer) {
                    pricePresetsContainer.addEventListener('click', function(e) {
                        if(e.target.classList.contains('price-tag')) {
                            var val = e.target.getAttribute('data-val');
                            var offerPriceInput = document.getElementById('offerPrice');
                            if(offerPriceInput) {
                                offerPriceInput.value = val;
                                calculate();
                            }
                        }
                    });
                }

                // Result & History (only for normal tabs)
                var btnCopyResult = document.getElementById('btnCopyResult');
                var btnAddToHistory = document.getElementById('btnAddToHistory');
                var btnClearHistory = document.getElementById('btnClearHistory');
                if(btnCopyResult) btnCopyResult.addEventListener('click', copyResultToClipboard);
                if(btnAddToHistory) btnAddToHistory.addEventListener('click', addToHistory);
                if(btnClearHistory) btnClearHistory.addEventListener('click', clearHistory);

                // Modals
                document.getElementById('btnCloseResModal').addEventListener('click', function() { closeModal('modalResources'); });
                document.getElementById('btnCloseTabModal').addEventListener('click', function() { closeModal('modalTabConfig'); });
                
                document.getElementById('btnAddNewRes').addEventListener('click', addNewResource);
                document.getElementById('btnResetDefaults').addEventListener('click', resetDefaults);
                document.getElementById('btnSaveTabConfig').addEventListener('click', saveTabConfig);
            }

            // --- STORAGE ---
            function safeSave() {
                try { localStorage.setItem('gemini_calc_v6', JSON.stringify(appData)); } catch(e) {}
            }
            function safeLoad() {
                try {
                    var saved = localStorage.getItem('gemini_calc_v6');
                    if (saved) {
                        appData = JSON.parse(saved);
                        if(!appData.resources) appData.resources = JSON.parse(JSON.stringify(defaultResources));
                        if(!appData.calcMode) appData.calcMode = 'normal'; // Default to normal mode
                        if(!appData.chainSlots) appData.chainSlots = []; // Default to empty chain
                        if(!appData.chestConfig) appData.chestConfig = { name: '', price: 0.99, items: [] }; // Default chest config
                    }
                } catch(e) {}
            }

            // --- CORE ---
            function switchTab(tabName) {
                appData.currentTab = tabName;
                document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
                var activeBtn = document.getElementById('tab_' + tabName);
                if(activeBtn) activeBtn.classList.add('active');

                // Set data attribute for tab-specific styling
                document.body.setAttribute('data-current-tab', tabName);

                safeSave();

                // Check if Chain tab or Chest tab
                if(tabName === 'chain') {
                    renderChainUI();
                } else if(tabName === 'chest') {
                    renderChestUI();
                } else {
                    renderNormalUI();
                    updateTabLabels(tabName);
                    renderInputs();
                    calculate();
                }
            }

            function updateTabLabels(tabName) {
                var tabTitle = document.getElementById('tabTitle');
                var offerNameLabel = document.querySelector('label[for="offerName"]');
                if(!offerNameLabel) {
                    offerNameLabel = document.querySelector('.input-group label');
                }
                var priceLabel = document.querySelector('label[style*="–¶–ï–ù–ê –ü–ê–ö–ê"]');
                if(!priceLabel) {
                    var labels = document.querySelectorAll('label');
                    for(var i = 0; i < labels.length; i++) {
                        if(labels[i].textContent.includes('–¶–ï–ù–ê –ü–ê–ö–ê') || labels[i].textContent.includes('–¶–ï–ù–ê –°–£–ù–î–£–ö–ê')) {
                            priceLabel = labels[i];
                            break;
                        }
                    }
                }
                var noAdsContainer = document.getElementById('cb_noads');
                if(noAdsContainer) noAdsContainer = noAdsContainer.parentElement.parentElement;

                // Update texts based on tab
                if(tabName === 'chest') {
                    if(tabTitle) tabTitle.textContent = 'Chest Config';
                    if(offerNameLabel) offerNameLabel.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–Ω–¥—É–∫–∞';
                    if(priceLabel) priceLabel.textContent = '–¶–ï–ù–ê –°–£–ù–î–£–ö–ê ($)';
                    if(noAdsContainer) noAdsContainer.style.display = 'none';
                } else {
                    if(tabTitle) tabTitle.textContent = 'Pack Config';
                    if(offerNameLabel) offerNameLabel.textContent = '–ù–∞–∑–≤–∞–Ω–∏–µ –û—Ñ–µ—Ä–∞';
                    if(priceLabel) priceLabel.textContent = '–¶–ï–ù–ê –ü–ê–ö–ê ($)';
                    if(noAdsContainer) noAdsContainer.style.display = 'block';
                }
            }

            function renderInputs() {
                var container = document.getElementById('dynamicInputs');
                if(!container) return; // Skip if on Chain tab or element doesn't exist
                container.innerHTML = '';
                var activeFields = appData.tabConfig[appData.currentTab] || [];
                
                activeFields.forEach(function(resId) {
                    var res = appData.resources.find(function(r){ return r.id === resId });
                    if (!res || res.isSpecial) return; 
                    
                    var div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = '<label>' + escapeHtml(res.name) + '</label>' +
                                    '<input type="number" class="calc-input" data-id="' + res.id + '" placeholder="0">';
                    
                    var inp = div.querySelector('input');
                    inp.addEventListener('input', calculate);
                    container.appendChild(div);
                });
            }

            function calculate() {
                var baseValue = 0;
                var inputs = document.querySelectorAll('#dynamicInputs .calc-input');
                inputs.forEach(function(inp) {
                    var count = parseFloat(inp.value) || 0;
                    var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                    if(res) baseValue += count * res.price;
                });

                var cb = document.getElementById('cb_noads');
                if(cb && cb.checked) {
                    var na = appData.resources.find(function(r){ return r.id === 'noads' });
                    if(na) baseValue += na.price;
                }

                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                
                var multi = 0;
                var roi = 0;
                var disc = 0;

                if (price > 0 && baseValue > 0) {
                    var profitRatio = (baseValue - price) / price;
                    multi = Math.max(1, Math.round(profitRatio));
                    roi = profitRatio * 100;
                    disc = (1 - (price / baseValue)) * 100;
                }

                document.getElementById('resBase').innerText = '$' + baseValue.toFixed(2);
                document.getElementById('resMulti').innerText = multi + "x"; 
                document.getElementById('resRoi').innerText = Math.max(0, roi).toFixed(0) + '%';
                document.getElementById('resDisc').innerText = Math.max(0, disc).toFixed(0) + '%';

                var card = document.getElementById('resCard');
                var badge = document.getElementById('resBadge');
                card.className = 'card result-card';
                
                if(price <= 0 || baseValue <= 0) {
                    card.classList.add('val-ok'); badge.innerText = "–í–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ";
                } else if (roi < 0) {
                    card.classList.add('val-bad'); badge.innerText = "Bad Deal";
                } else if (roi < 100) {
                    card.classList.add('val-ok'); badge.innerText = "Normal";
                } else if (roi < 250) {
                    card.classList.add('val-good'); badge.innerText = "Good";
                } else if (roi < 500) {
                    card.classList.add('val-epic'); badge.innerText = "Epic";
                } else {
                    card.classList.add('val-legendary'); badge.innerText = "Legendary";
                }

                // Update reverse mode if active
                if(appData.calcMode === 'reverse') {
                    updateReverseMode();
                }
            }

            // --- CHAIN MODE ---
            function renderNormalUI() {
                var wrapper = document.getElementById('mainWrapper');

                // Check if normal UI exists, if not restore from saved HTML
                if(!document.getElementById('dynamicInputs')) {
                    wrapper.innerHTML = originalMainWrapperHTML;

                    // Re-bind events for normal tab elements after restoration
                    var btnOpenTabConfig = document.getElementById('btnOpenTabConfig');
                    var cb_noads = document.getElementById('cb_noads');
                    var offerPrice = document.getElementById('offerPrice');
                    if(btnOpenTabConfig) btnOpenTabConfig.addEventListener('click', openTabConfig);
                    if(cb_noads) cb_noads.addEventListener('change', calculate);
                    if(offerPrice) offerPrice.addEventListener('input', calculate);

                    var pricePresetsContainer = document.getElementById('pricePresetsContainer');
                    if(pricePresetsContainer) {
                        pricePresetsContainer.addEventListener('click', function(e) {
                            if(e.target.classList.contains('price-tag')) {
                                var val = e.target.getAttribute('data-val');
                                var offerPriceInput = document.getElementById('offerPrice');
                                if(offerPriceInput) {
                                    offerPriceInput.value = val;
                                    calculate();
                                }
                            }
                        });
                    }

                    var btnCopyResult = document.getElementById('btnCopyResult');
                    var btnAddToHistory = document.getElementById('btnAddToHistory');
                    if(btnCopyResult) btnCopyResult.addEventListener('click', copyResultToClipboard);
                    if(btnAddToHistory) btnAddToHistory.addEventListener('click', addToHistory);

                    var modeNormal = document.getElementById('modeNormal');
                    var modeReverse = document.getElementById('modeReverse');
                    if(modeNormal) modeNormal.addEventListener('click', function() { setCalcMode('normal'); });
                    if(modeReverse) modeReverse.addEventListener('click', function() { setCalcMode('reverse'); });

                    var targetMulti = document.getElementById('targetMulti');
                    var targetROI = document.getElementById('targetROI');
                    var targetDiscount = document.getElementById('targetDiscount');
                    if(targetMulti) targetMulti.addEventListener('input', onTargetMultiChange);
                    if(targetROI) targetROI.addEventListener('input', onTargetROIChange);
                    if(targetDiscount) targetDiscount.addEventListener('input', onTargetDiscountChange);
                }
            }

            function renderChainUI() {
                var wrapper = document.getElementById('mainWrapper');

                // Build Chain UI
                wrapper.innerHTML = '';

                // Left column: Slots list
                var leftCard = document.createElement('div');
                leftCard.className = 'card';
                leftCard.style.gridColumn = '1';
                leftCard.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">' +
                    '<h3>‚õì Chain Slots</h3>' +
                    '<button class="btn-primary btn-icon" id="btnAddSlot">+ Add Slot</button>' +
                    '</div>' +
                    '<div id="chainSlotsContainer" class="chain-container"></div>';

                // Right column: Results
                var rightCard = document.createElement('div');
                rightCard.className = 'card chain-result-card';
                rightCard.innerHTML = '<h3 style="text-align:center; margin-bottom:20px;">Chain Summary</h3>' +
                    '<div class="chain-summary">' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Total Slots</div><div class="chain-summary-value" id="chainTotalSlots">0</div></div>' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Total Spent</div><div class="chain-summary-value" id="chainTotalSpent">$0.00</div></div>' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Cumulative Value</div><div class="chain-summary-value" id="chainCumulativeValue">$0.00</div></div>' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Average ROI</div><div class="chain-summary-value" id="chainAvgROI">0%</div></div>' +
                    '</div>' +
                    '<button class="btn-primary" style="margin-top:20px; width:100%;" id="btnCopyChain">üìã Copy Chain</button>';

                wrapper.appendChild(leftCard);
                wrapper.appendChild(rightCard);

                // Bind events
                document.getElementById('btnAddSlot').addEventListener('click', addChainSlot);
                document.getElementById('btnCopyChain').addEventListener('click', copyChainToClipboard);

                // Render existing slots
                renderChainSlots();
            }

            function renderChainSlots() {
                var container = document.getElementById('chainSlotsContainer');
                if(!container) return;

                container.innerHTML = '';

                if(appData.chainSlots.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);">No slots yet. Click "Add Slot" to start building your chain.</div>';
                    updateChainResults();
                    return;
                }

                appData.chainSlots.forEach(function(slot, index) {
                    var slotCard = createSlotCard(slot, index);
                    container.appendChild(slotCard);
                });

                updateChainResults();
            }

            function createSlotCard(slot, index) {
                var card = document.createElement('div');
                card.className = 'slot-card ' + (slot.type === 'free' ? 'free-slot' : 'paid-slot');

                var html = '<div class="slot-header">' +
                    '<div><strong>Slot ' + (index + 1) + '</strong></div>' +
                    '<div class="slot-type-toggle">' +
                    '<button class="slot-type-btn ' + (slot.type === 'free' ? 'active' : '') + '" data-type="free" data-index="' + index + '">Free</button>' +
                    '<button class="slot-type-btn ' + (slot.type === 'paid' ? 'active' : '') + '" data-type="paid" data-index="' + index + '">Paid</button>' +
                    '</div>' +
                    '</div>';

                // Price for paid slots
                if(slot.type === 'paid') {
                    html += '<div style="margin-bottom:15px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">Slot Price ($)</label>' +
                        '<input type="number" class="slot-price-input" data-index="' + index + '" value="' + (slot.price || 0) + '" step="0.01" min="0" style="width:100%;"></div>';
                }

                // Items (up to 3)
                html += '<div class="slot-items">';
                for(var i = 0; i < 3; i++) {
                    var item = slot.items[i] || { resourceId: '', count: 0 };
                    html += '<div class="slot-item">' +
                        '<select class="slot-res-select" data-index="' + index + '" data-item="' + i + '">' +
                        '<option value="">---</option>';

                    appData.resources.forEach(function(res) {
                        if(res.isSpecial) return;
                        var selected = item.resourceId === res.id ? 'selected' : '';
                        html += '<option value="' + res.id + '" ' + selected + '>' + escapeHtml(res.name) + '</option>';
                    });

                    html += '</select>' +
                        '<input type="number" class="slot-item-count" data-index="' + index + '" data-item="' + i + '" value="' + item.count + '" min="0" placeholder="Count">' +
                        '</div>';
                }
                html += '</div>';

                // Metrics
                var metrics = calculateSlotMetrics(slot, index);
                html += '<div class="slot-metrics">' +
                    '<div class="slot-metric"><div class="slot-metric-label">Base Value</div><div class="slot-metric-value">$' + metrics.baseValue.toFixed(2) + '</div></div>';

                if(slot.type === 'paid') {
                    html += '<div class="slot-metric"><div class="slot-metric-label">Discount</div><div class="slot-metric-value">' + metrics.discount.toFixed(0) + '%</div></div>';
                } else {
                    html += '<div class="slot-metric"><div class="slot-metric-label">Free Item %</div><div class="slot-metric-value">' + metrics.freeItemPercent.toFixed(1) + '%</div></div>';
                }

                html += '<div class="slot-metric"><div class="slot-metric-label">Cumul. Value</div><div class="slot-metric-value">$' + metrics.cumulativeValue.toFixed(2) + '</div></div>' +
                    '<div class="slot-metric"><div class="slot-metric-label">Total Spent</div><div class="slot-metric-value">$' + metrics.totalSpent.toFixed(2) + '</div></div>' +
                    '</div>';

                // Delete button
                html += '<button class="btn-delete-slot" data-index="' + index + '">√ó</button>';

                card.innerHTML = html;

                // Bind events
                card.querySelectorAll('.slot-type-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        changeSlotType(parseInt(this.getAttribute('data-index')), this.getAttribute('data-type'));
                    });
                });

                var priceInput = card.querySelector('.slot-price-input');
                if(priceInput) {
                    priceInput.addEventListener('input', function() {
                        updateSlotPrice(parseInt(this.getAttribute('data-index')), parseFloat(this.value) || 0);
                    });
                }

                card.querySelectorAll('.slot-res-select').forEach(function(sel) {
                    sel.addEventListener('change', function() {
                        updateSlotItem(parseInt(this.getAttribute('data-index')), parseInt(this.getAttribute('data-item')), 'resourceId', this.value);
                    });
                });

                card.querySelectorAll('.slot-item-count').forEach(function(inp) {
                    inp.addEventListener('input', function() {
                        updateSlotItem(parseInt(this.getAttribute('data-index')), parseInt(this.getAttribute('data-item')), 'count', parseFloat(this.value) || 0);
                    });
                });

                card.querySelector('.btn-delete-slot').addEventListener('click', function() {
                    deleteChainSlot(parseInt(this.getAttribute('data-index')));
                });

                return card;
            }

            function addChainSlot() {
                var newSlot = {
                    type: 'free',
                    price: 0,
                    items: [
                        { resourceId: '', count: 0 },
                        { resourceId: '', count: 0 },
                        { resourceId: '', count: 0 }
                    ]
                };
                appData.chainSlots.push(newSlot);
                safeSave();
                renderChainSlots();
            }

            function deleteChainSlot(index) {
                if(confirm('Delete this slot?')) {
                    appData.chainSlots.splice(index, 1);
                    safeSave();
                    renderChainSlots();
                }
            }

            function changeSlotType(index, type) {
                appData.chainSlots[index].type = type;
                if(type === 'free') {
                    appData.chainSlots[index].price = 0;
                }
                safeSave();
                renderChainSlots();
            }

            function updateSlotPrice(index, price) {
                appData.chainSlots[index].price = price;
                safeSave();

                // Update only metrics display, not the entire slot
                updateSlotMetricsDisplay(index);
                updateChainResults();
            }

            function updateSlotItem(index, itemIndex, field, value) {
                appData.chainSlots[index].items[itemIndex][field] = value;
                safeSave();

                // Update only metrics display, not the entire slot
                updateSlotMetricsDisplay(index);
                updateChainResults();
            }

            function updateSlotMetricsDisplay(index) {
                // Find the slot card in DOM
                var slotCards = document.querySelectorAll('.slot-card');
                if(!slotCards[index]) return;

                var slot = appData.chainSlots[index];
                var metrics = calculateSlotMetrics(slot, index);

                // Find metrics container within this slot card
                var metricsContainer = slotCards[index].querySelector('.slot-metrics');
                if(!metricsContainer) return;

                // Update metrics HTML
                var html = '<div class="slot-metric"><div class="slot-metric-label">Base Value</div><div class="slot-metric-value">$' + metrics.baseValue.toFixed(2) + '</div></div>';

                if(slot.type === 'paid') {
                    html += '<div class="slot-metric"><div class="slot-metric-label">Discount</div><div class="slot-metric-value">' + metrics.discount.toFixed(0) + '%</div></div>';
                } else {
                    html += '<div class="slot-metric"><div class="slot-metric-label">Free Item %</div><div class="slot-metric-value">' + metrics.freeItemPercent.toFixed(1) + '%</div></div>';
                }

                html += '<div class="slot-metric"><div class="slot-metric-label">Cumul. Value</div><div class="slot-metric-value">$' + metrics.cumulativeValue.toFixed(2) + '</div></div>' +
                    '<div class="slot-metric"><div class="slot-metric-label">Total Spent</div><div class="slot-metric-value">$' + metrics.totalSpent.toFixed(2) + '</div></div>';

                metricsContainer.innerHTML = html;
            }

            function calculateSlotMetrics(slot, index) {
                // Calculate base value
                var baseValue = 0;
                slot.items.forEach(function(item) {
                    if(item.resourceId) {
                        var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                        if(res) baseValue += item.count * res.price;
                    }
                });

                // Calculate cumulative and total spent up to this slot
                var cumulativeValue = 0;
                var totalSpent = 0;
                for(var i = 0; i <= index; i++) {
                    var s = appData.chainSlots[i];
                    s.items.forEach(function(item) {
                        if(item.resourceId) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) cumulativeValue += item.count * res.price;
                        }
                    });
                    if(s.type === 'paid') {
                        totalSpent += s.price || 0;
                    }
                }

                // Calculate discount for paid slots
                var discount = 0;
                if(slot.type === 'paid' && slot.price > 0 && baseValue > 0) {
                    discount = (1 - (slot.price / baseValue)) * 100;
                }

                // Calculate free item % for free slots
                // New logic: Free slots calculate % relative to reference paid slot
                // - If free slot is BEFORE any paid slot ‚Üí use first paid slot AFTER
                // - If free slot is AFTER paid slot ‚Üí use last paid slot BEFORE
                var freeItemPercent = 0;
                if(slot.type === 'free') {
                    var referencePaidSlot = null;

                    // Step 1: Try to find last paid slot BEFORE current
                    for(var i = index - 1; i >= 0; i--) {
                        if(appData.chainSlots[i].type === 'paid') {
                            referencePaidSlot = appData.chainSlots[i];
                            break;
                        }
                    }

                    // Step 2: If not found, find first paid slot AFTER current
                    if(!referencePaidSlot) {
                        for(var i = index + 1; i < appData.chainSlots.length; i++) {
                            if(appData.chainSlots[i].type === 'paid') {
                                referencePaidSlot = appData.chainSlots[i];
                                break;
                            }
                        }
                    }

                    // Step 3: Calculate percentage relative to reference paid slot
                    if(referencePaidSlot && referencePaidSlot.price > 0) {
                        freeItemPercent = (baseValue / referencePaidSlot.price) * 100;
                    }
                }

                return {
                    baseValue: baseValue,
                    discount: discount,
                    freeItemPercent: freeItemPercent,
                    cumulativeValue: cumulativeValue,
                    totalSpent: totalSpent
                };
            }

            function updateChainResults() {
                var totalSlots = appData.chainSlots.length;
                var totalSpent = 0;
                var cumulativeValue = 0;

                appData.chainSlots.forEach(function(slot) {
                    slot.items.forEach(function(item) {
                        if(item.resourceId) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) cumulativeValue += item.count * res.price;
                        }
                    });
                    if(slot.type === 'paid') {
                        totalSpent += slot.price || 0;
                    }
                });

                var avgROI = 0;
                if(totalSpent > 0) {
                    avgROI = ((cumulativeValue - totalSpent) / totalSpent) * 100;
                }

                document.getElementById('chainTotalSlots').innerText = totalSlots;
                document.getElementById('chainTotalSpent').innerText = '$' + totalSpent.toFixed(2);
                document.getElementById('chainCumulativeValue').innerText = '$' + cumulativeValue.toFixed(2);
                document.getElementById('chainAvgROI').innerText = avgROI.toFixed(0) + '%';
            }

            function copyChainToClipboard() {
                var text = 'Chain Offer (' + appData.chainSlots.length + ' slots):\n';

                appData.chainSlots.forEach(function(slot, index) {
                    var metrics = calculateSlotMetrics(slot, index);
                    var items = [];
                    slot.items.forEach(function(item) {
                        if(item.resourceId && item.count > 0) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) items.push(item.count + ' ' + res.name);
                        }
                    });

                    var slotText = '- Slot ' + (index + 1) + ' (' + (slot.type === 'free' ? 'Free' : 'Paid $' + slot.price.toFixed(2)) + '): ' +
                        (items.length > 0 ? items.join(', ') : 'empty') +
                        ' | Value: $' + metrics.baseValue.toFixed(2);

                    if(slot.type === 'paid') {
                        slotText += ' (' + metrics.discount.toFixed(0) + '% OFF)';
                    }

                    text += slotText + '\n';
                });

                var totalSpent = 0;
                var cumulativeValue = 0;
                appData.chainSlots.forEach(function(slot) {
                    var metrics = calculateSlotMetrics(slot, appData.chainSlots.indexOf(slot));
                    if(slot.type === 'paid') totalSpent += slot.price || 0;
                });
                appData.chainSlots.forEach(function(slot) {
                    slot.items.forEach(function(item) {
                        if(item.resourceId) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) cumulativeValue += item.count * res.price;
                        }
                    });
                });

                var avgROI = totalSpent > 0 ? ((cumulativeValue - totalSpent) / totalSpent) * 100 : 0;
                text += '\nTotal: $' + totalSpent.toFixed(2) + ' ‚Üí $' + cumulativeValue.toFixed(2) + ' | Average ROI: ' + avgROI.toFixed(0) + '%';

                navigator.clipboard.writeText(text).then(function() {
                    var btn = document.getElementById('btnCopyChain');
                    var originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì Copied!';
                    btn.style.background = 'var(--success)';
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(function(err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:\n\n' + text);
                });
            }

            // --- CHEST CALCULATOR ---
            function renderChestUI() {
                var wrapper = document.getElementById('mainWrapper');
                wrapper.innerHTML = '';

                // Left column: Chest configuration
                var leftCard = document.createElement('div');
                leftCard.className = 'card';
                leftCard.style.gridColumn = '1';
                leftCard.innerHTML =
                    '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">' +
                    '<h3>üéÅ Chest Config</h3>' +
                    '</div>' +

                    // Mode Toggle
                    '<div class="mode-toggle">' +
                    '<button id="chestModeNormal" class="active">üìä –û–±—ã—á–Ω—ã–π</button>' +
                    '<button id="chestModeReverse">üéØ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>' +
                    '</div>' +

                    // Chest Name
                    '<div class="input-group" style="margin-bottom: 20px;">' +
                    '<label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–Ω–¥—É–∫–∞</label>' +
                    '<input type="text" id="chestName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="' + escapeHtml(appData.chestConfig.name) + '">' +
                    '</div>' +

                    // Reverse Mode Section (hidden by default)
                    '<div class="reverse-section" id="chestReverseSection" style="display:none;">' +
                    '<label style="font-weight:bold; color:var(--warning); display:block; margin-bottom:10px;">üéØ –¶–ï–õ–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò</label>' +
                    '<div class="reverse-fields">' +
                    '<div class="input-group"><label>Multiplier (X)</label><input type="number" id="chestTargetMulti" placeholder="5" min="1" step="1" value="5"></div>' +
                    '<div class="input-group"><label>ROI %</label><input type="number" id="chestTargetROI" placeholder="400" min="0" step="1" value="400"></div>' +
                    '<div class="input-group"><label>Discount %</label><input type="number" id="chestTargetDiscount" placeholder="80" min="0" max="99" step="1" value="80"></div>' +
                    '</div>' +
                    '<div style="margin-top:10px; padding:10px; background:#1a1a1a; border-radius:6px; text-align:center;">' +
                    '<div style="font-size:0.85em; color:var(--text-sec);">–¢—Ä–µ–±—É–µ–º–∞—è —Å—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ:</div>' +
                    '<div style="font-size:1.8em; font-weight:bold; color:var(--warning); margin-top:5px;" id="chestTargetValue">$0.00</div>' +
                    '</div>' +
                    '<div id="chestRecommendation" style="margin-top:10px; padding:10px; background:#1a1a1a; border-radius:6px; font-size:0.9em; color:var(--text-sec);"></div>' +
                    '</div>' +

                    // Items List
                    '<div style="margin-top:20px;">' +
                    '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">' +
                    '<label style="font-weight:bold;">–ü—Ä–µ–¥–º–µ—Ç—ã –≤ —Å—É–Ω–¥—É–∫–µ</label>' +
                    '<button class="btn-primary btn-icon" id="btnAddChestItem">+ –î–æ–±–∞–≤–∏—Ç—å</button>' +
                    '</div>' +
                    '<div id="chestItemsContainer"></div>' +
                    '</div>' +

                    // Price Section
                    '<div style="margin-top: 25px; background: #252525; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">' +
                    '<label style="color: var(--warning); font-weight: bold; display:block; margin-bottom:5px;">–¶–ï–ù–ê –°–£–ù–î–£–ö–ê ($)</label>' +
                    '<input type="number" id="chestPrice" step="0.5" min="0.49" value="' + appData.chestConfig.price + '" style="font-size: 1.4em; font-weight: bold; color: var(--warning);">' +
                    '<div class="price-presets" id="chestPricePresets">' +
                    '<div class="price-tag" data-val="0.99">$0.99</div>' +
                    '<div class="price-tag" data-val="1.99">$1.99</div>' +
                    '<div class="price-tag" data-val="2.99">$2.99</div>' +
                    '<div class="price-tag" data-val="3.99">$3.99</div>' +
                    '<div class="price-tag" data-val="4.99">$4.99</div>' +
                    '<div class="price-tag" data-val="7.99">$7.99</div>' +
                    '<div class="price-tag" data-val="9.99">$9.99</div>' +
                    '<div class="price-tag" data-val="14.99">$14.99</div>' +
                    '<div class="price-tag" data-val="19.99">$19.99</div>' +
                    '<div class="price-tag" data-val="24.99">$24.99</div>' +
                    '</div>' +
                    '</div>';

                // Right column: Results and Simulator
                var rightCard = document.createElement('div');
                rightCard.className = 'card';
                rightCard.innerHTML =
                    '<h3 style="text-align:center; margin-bottom:20px;">üì¶ –ê–Ω–∞–ª–∏–∑ —Å—É–Ω–¥—É–∫–∞</h3>' +
                    '<div id="chestResults"></div>' +
                    '<hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">' +
                    '<h4 style="margin-bottom:15px;">üé≤ –°–∏–º—É–ª—è—Ç–æ—Ä –æ—Ç–∫—Ä—ã—Ç–∏—è</h4>' +
                    '<div id="chestSimulator"></div>';

                wrapper.appendChild(leftCard);
                wrapper.appendChild(rightCard);

                // Bind events
                document.getElementById('chestModeNormal').addEventListener('click', function() { setChestCalcMode('normal'); });
                document.getElementById('chestModeReverse').addEventListener('click', function() { setChestCalcMode('reverse'); });
                document.getElementById('chestName').addEventListener('input', function() {
                    appData.chestConfig.name = this.value;
                    safeSave();
                });
                document.getElementById('chestPrice').addEventListener('input', calculateChest);
                document.getElementById('btnAddChestItem').addEventListener('click', addChestItem);

                // Price presets
                document.getElementById('chestPricePresets').addEventListener('click', function(e) {
                    if(e.target.classList.contains('price-tag')) {
                        document.getElementById('chestPrice').value = e.target.getAttribute('data-val');
                        calculateChest();
                    }
                });

                // Reverse mode inputs
                var chestTargetMulti = document.getElementById('chestTargetMulti');
                var chestTargetROI = document.getElementById('chestTargetROI');
                var chestTargetDiscount = document.getElementById('chestTargetDiscount');
                if(chestTargetMulti) chestTargetMulti.addEventListener('input', onChestTargetMultiChange);
                if(chestTargetROI) chestTargetROI.addEventListener('input', onChestTargetROIChange);
                if(chestTargetDiscount) chestTargetDiscount.addEventListener('input', onChestTargetDiscountChange);

                // Render existing items
                renderChestItems();
                renderChestSimulator();
                calculateChest();
            }

            function renderChestItems() {
                var container = document.getElementById('chestItemsContainer');
                if(!container) return;

                if(appData.chestConfig.items.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec); font-size:0.9em;">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ "+ –î–æ–±–∞–≤–∏—Ç—å"</div>';
                    return;
                }

                container.innerHTML = '';
                appData.chestConfig.items.forEach(function(item, index) {
                    var itemCard = createChestItemCard(item, index);
                    container.appendChild(itemCard);
                });
            }

            function createChestItemCard(item, index) {
                var card = document.createElement('div');
                card.className = 'slot-card';
                card.style.marginBottom = '15px';
                card.style.position = 'relative';

                var html = '<div style="margin-bottom:10px;"><strong>–ü—Ä–µ–¥–º–µ—Ç #' + (index + 1) + '</strong></div>';

                // Resource dropdown
                html += '<div style="margin-bottom:10px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">–†–µ—Å—É—Ä—Å</label>' +
                    '<select class="chest-item-resource" data-index="' + index + '" style="width:100%; padding:8px; background:var(--surface); border:1px solid var(--border); color:white; border-radius:4px;">' +
                    '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å --</option>';

                appData.resources.forEach(function(res) {
                    if(res.isSpecial) return;
                    var selected = item.resourceId === res.id ? 'selected' : '';
                    html += '<option value="' + res.id + '" ' + selected + '>' + escapeHtml(res.name) + '</option>';
                });

                html += '</select></div>';

                // Random quantity checkbox
                html += '<div style="margin-bottom:10px;"><label style="display:flex; align-items:center; cursor:pointer; gap:8px;">' +
                    '<input type="checkbox" class="chest-item-random" data-index="' + index + '" ' + (item.isRandom ? 'checked' : '') + ' style="width:18px; height:18px;">' +
                    '<span>–°–ª—É—á–∞–π–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>' +
                    '</label></div>';

                // Quantity fields
                if(item.isRandom) {
                    html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">' +
                        '<div><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">Min</label>' +
                        '<input type="number" class="chest-item-min" data-index="' + index + '" value="' + (item.minQty || 0) + '" min="0" style="width:100%;"></div>' +
                        '<div><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">Max</label>' +
                        '<input type="number" class="chest-item-max" data-index="' + index + '" value="' + (item.maxQty || 0) + '" min="0" style="width:100%;"></div>' +
                        '</div>';
                } else {
                    html += '<div style="margin-bottom:10px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>' +
                        '<input type="number" class="chest-item-qty" data-index="' + index + '" value="' + (item.minQty || 0) + '" min="0" style="width:100%;"></div>';
                }

                // Drop chance
                html += '<div style="margin-bottom:10px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">–®–∞–Ω—Å –¥—Ä–æ–ø–∞ (%)</label>' +
                    '<input type="number" class="chest-item-chance" data-index="' + index + '" value="' + (item.dropChance || 0) + '" min="0" max="100" step="1" style="width:100%;"></div>';

                // Rarity
                html += '<div style="margin-bottom:10px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">–†–µ–¥–∫–æ—Å—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>' +
                    '<input type="text" class="chest-item-rarity" data-index="' + index + '" value="' + escapeHtml(item.rarity || '') + '" placeholder="Common, Rare, Epic..." style="width:100%;"></div>';

                // Delete button
                html += '<button class="btn-delete-slot" data-index="' + index + '">√ó</button>';

                card.innerHTML = html;

                // Bind events
                card.querySelector('.chest-item-resource').addEventListener('change', function() {
                    updateChestItem(index, 'resourceId', this.value);
                });
                card.querySelector('.chest-item-random').addEventListener('change', function() {
                    updateChestItem(index, 'isRandom', this.checked);
                });
                var minInput = card.querySelector('.chest-item-min');
                if(minInput) {
                    minInput.addEventListener('input', function() {
                        updateChestItem(index, 'minQty', parseFloat(this.value) || 0);
                    });
                }
                var maxInput = card.querySelector('.chest-item-max');
                if(maxInput) {
                    maxInput.addEventListener('input', function() {
                        updateChestItem(index, 'maxQty', parseFloat(this.value) || 0);
                    });
                }
                var qtyInput = card.querySelector('.chest-item-qty');
                if(qtyInput) {
                    qtyInput.addEventListener('input', function() {
                        updateChestItem(index, 'minQty', parseFloat(this.value) || 0);
                        updateChestItem(index, 'maxQty', parseFloat(this.value) || 0);
                    });
                }
                card.querySelector('.chest-item-chance').addEventListener('input', function() {
                    updateChestItem(index, 'dropChance', parseFloat(this.value) || 0);
                });
                card.querySelector('.chest-item-rarity').addEventListener('input', function() {
                    updateChestItem(index, 'rarity', this.value);
                });
                card.querySelector('.btn-delete-slot').addEventListener('click', function() {
                    deleteChestItem(index);
                });

                return card;
            }

            function addChestItem() {
                var newItem = {
                    resourceId: '',
                    isRandom: false,
                    minQty: 0,
                    maxQty: 0,
                    dropChance: 100,
                    rarity: ''
                };
                appData.chestConfig.items.push(newItem);
                safeSave();
                renderChestItems();
                calculateChest();
            }

            function deleteChestItem(index) {
                if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
                    appData.chestConfig.items.splice(index, 1);
                    safeSave();
                    renderChestItems();
                    calculateChest();
                }
            }

            function updateChestItem(index, field, value) {
                appData.chestConfig.items[index][field] = value;
                safeSave();
                if(field === 'isRandom') {
                    renderChestItems(); // Re-render to show/hide min/max fields
                } else {
                    calculateChest();
                }
            }

            function calculateChest() {
                var price = parseFloat(document.getElementById('chestPrice').value) || 0;
                appData.chestConfig.price = price;

                var ev = 0; // Expected Value
                var avgItems = 0; // Average items per opening
                var itemDetails = [];

                appData.chestConfig.items.forEach(function(item) {
                    if(!item.resourceId) return;

                    var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                    if(!res) return;

                    var avgQty = 0;
                    if(item.isRandom) {
                        var min = item.minQty || 0;
                        var max = item.maxQty || 0;
                        if(min > 0 && max === 0) avgQty = min;
                        else if(min === 0 && max > 0) avgQty = max;
                        else avgQty = (min + max) / 2;
                    } else {
                        avgQty = item.minQty || 0;
                    }

                    var dropChance = (item.dropChance || 0) / 100;
                    var itemValue = res.price * avgQty * dropChance;
                    ev += itemValue;
                    avgItems += dropChance; // Average number of items that will drop

                    itemDetails.push({
                        name: res.name,
                        avgQty: avgQty,
                        dropChance: item.dropChance || 0,
                        value: itemValue,
                        rarity: item.rarity || '',
                        isRandom: item.isRandom,
                        minQty: item.minQty,
                        maxQty: item.maxQty
                    });
                });

                // Calculate ROI, Discount, Multiplier
                var roi = 0;
                var discount = 0;
                var multi = 0;

                if(price > 0 && ev > 0) {
                    roi = ((ev - price) / price) * 100;
                    discount = (1 - (price / ev)) * 100;
                    multi = Math.max(1, Math.round((ev - price) / price));
                }

                // Render results
                renderChestResults(ev, price, roi, discount, multi, itemDetails, avgItems);

                // Update reverse mode if active
                if(appData.calcMode === 'reverse') {
                    updateChestReverseMode(ev, price);
                }

                safeSave();
            }

            function renderChestResults(ev, price, roi, discount, multi, itemDetails, avgItems) {
                var container = document.getElementById('chestResults');
                if(!container) return;

                // Determine quality class
                var qualityClass = 'val-ok';
                var qualityBadge = 'Normal';
                if(roi < 0) { qualityClass = 'val-bad'; qualityBadge = 'Bad Deal'; }
                else if(roi >= 500) { qualityClass = 'val-legendary'; qualityBadge = 'Legendary'; }
                else if(roi >= 250) { qualityClass = 'val-epic'; qualityBadge = 'Epic'; }
                else if(roi >= 100) { qualityClass = 'val-good'; qualityBadge = 'Good'; }

                var html = '<div class="' + qualityClass + '" style="border:2px solid; border-radius:8px; padding:15px; margin-bottom:20px;">' +
                    '<div class="badge">' + qualityBadge + '</div>' +
                    '<div style="text-align:center; margin-top:10px;">' +
                    '<div style="font-size:0.9em; color:var(--text-sec);">Expected Value (EV)</div>' +
                    '<div style="font-size:2.5em; font-weight:800; margin:5px 0;">$' + ev.toFixed(2) + '</div>' +
                    '<div style="font-size:1.2em; margin-bottom:10px;">ROI: <strong>' + Math.max(0, roi).toFixed(0) + '%</strong></div>' +
                    '</div>' +
                    '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding-top:10px; border-top:1px solid var(--border);">' +
                    '<div style="text-align:center;"><div style="color:var(--text-sec); font-size:0.85em;">–¶–µ–Ω–∞</div><div style="font-weight:bold;">$' + price.toFixed(2) + '</div></div>' +
                    '<div style="text-align:center;"><div style="color:var(--text-sec); font-size:0.85em;">Multiplier</div><div style="font-weight:bold;">' + multi + 'x</div></div>' +
                    '<div style="text-align:center;"><div style="color:var(--text-sec); font-size:0.85em;">Discount</div><div style="font-weight:bold;">' + Math.max(0, discount).toFixed(0) + '%</div></div>' +
                    '<div style="text-align:center;"><div style="color:var(--text-sec); font-size:0.85em;">Avg items</div><div style="font-weight:bold;">' + avgItems.toFixed(1) + '</div></div>' +
                    '</div>' +
                    '</div>';

                // Item details
                if(itemDetails.length > 0) {
                    html += '<h4 style="margin-bottom:10px;">üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h4>';
                    itemDetails.forEach(function(detail) {
                        var qtyText = detail.isRandom ?
                            detail.minQty + '-' + detail.maxQty + ' (avg: ' + detail.avgQty.toFixed(1) + ')' :
                            detail.avgQty.toFixed(0);
                        var rarityText = detail.rarity ? ' [' + detail.rarity + ']' : '';

                        html += '<div style="background:var(--surface-2); padding:12px; border-radius:6px; margin-bottom:10px;">' +
                            '<div style="display:flex; justify-content:space-between; margin-bottom:5px;">' +
                            '<strong>' + escapeHtml(detail.name) + rarityText + '</strong>' +
                            '<span style="color:var(--warning); font-weight:bold;">$' + detail.value.toFixed(2) + '</span>' +
                            '</div>' +
                            '<div style="font-size:0.85em; color:var(--text-sec); margin-bottom:5px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ' + qtyText + ' | –®–∞–Ω—Å: ' + detail.dropChance + '%</div>' +
                            '<div style="background:var(--surface); border-radius:4px; height:8px; overflow:hidden;">' +
                            '<div style="background:linear-gradient(90deg, #FFB300, #FF5722); width:' + detail.dropChance + '%; height:100%;"></div>' +
                            '</div>' +
                            '</div>';
                    });
                }

                // Action buttons
                html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:20px;">' +
                    '<button class="btn-primary" id="btnCopyChest">üìã Copy</button>' +
                    '<button class="btn-primary" id="btnCompareChest">‚¨á –°—Ä–∞–≤–Ω–∏—Ç—å</button>' +
                    '</div>';

                container.innerHTML = html;

                // Bind buttons
                var btnCopy = document.getElementById('btnCopyChest');
                var btnCompare = document.getElementById('btnCompareChest');
                if(btnCopy) btnCopy.addEventListener('click', copyChestToClipboard);
                if(btnCompare) btnCompare.addEventListener('click', addChestToHistory);
            }

            function renderChestSimulator() {
                var container = document.getElementById('chestSimulator');
                if(!container) return;

                container.innerHTML =
                    '<div style="margin-bottom:10px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">–û—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫–æ–≤:</label>' +
                    '<input type="number" id="simIterations" value="100" min="1" step="1" style="width:100%;"></div>' +
                    '<button class="btn-primary" id="btnSimulate" style="width:100%;">üé∞ –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å</button>' +
                    '<div id="simResults" style="margin-top:15px;"></div>';

                document.getElementById('btnSimulate').addEventListener('click', runChestSimulation);
            }

            function runChestSimulation() {
                var iterations = parseInt(document.getElementById('simIterations').value) || 100;
                var price = parseFloat(document.getElementById('chestPrice').value) || 0;

                var totalValue = 0;
                var dropCounts = {};

                // Initialize drop counts
                appData.chestConfig.items.forEach(function(item) {
                    if(item.resourceId) {
                        var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                        if(res) dropCounts[res.name] = { count: 0, totalQty: 0 };
                    }
                });

                // Run simulation
                for(var i = 0; i < iterations; i++) {
                    appData.chestConfig.items.forEach(function(item) {
                        if(!item.resourceId) return;

                        var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                        if(!res) return;

                        var dropChance = (item.dropChance || 0) / 100;
                        var drops = Math.random() < dropChance;

                        if(drops) {
                            var qty = 0;
                            if(item.isRandom) {
                                var min = item.minQty || 0;
                                var max = item.maxQty || 0;
                                if(min > 0 && max === 0) qty = min;
                                else if(min === 0 && max > 0) qty = max;
                                else qty = Math.floor(Math.random() * (max - min + 1)) + min;
                            } else {
                                qty = item.minQty || 0;
                            }

                            dropCounts[res.name].count++;
                            dropCounts[res.name].totalQty += qty;
                            totalValue += res.price * qty;
                        }
                    });
                }

                var avgValue = totalValue / iterations;
                var totalSpent = price * iterations;
                var totalReceived = totalValue;
                var simROI = totalSpent > 0 ? ((totalReceived - totalSpent) / totalSpent) * 100 : 0;

                // Render results
                var resultsContainer = document.getElementById('simResults');
                var html = '<div style="background:var(--surface-2); padding:15px; border-radius:8px;">' +
                    '<h4 style="margin-top:0;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∏–º—É–ª—è—Ü–∏–∏</h4>' +
                    '<div style="margin-bottom:10px;"><strong>–û—Ç–∫—Ä—ã—Ç–æ —Å—É–Ω–¥—É–∫–æ–≤:</strong> ' + iterations + '</div>' +
                    '<div style="margin-bottom:10px;"><strong>–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> $' + avgValue.toFixed(2) + '</div>' +
                    '<div style="margin-bottom:10px;"><strong>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ:</strong> $' + totalSpent.toFixed(2) + '</div>' +
                    '<div style="margin-bottom:10px;"><strong>–ü–æ–ª—É—á–µ–Ω–æ:</strong> $' + totalReceived.toFixed(2) + '</div>' +
                    '<div style="margin-bottom:15px;"><strong>ROI:</strong> ' + simROI.toFixed(1) + '%</div>' +
                    '<div style="border-top:1px solid var(--border); padding-top:10px;">' +
                    '<strong>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥—Ä–æ–ø–æ–≤:</strong>' +
                    '<ul style="margin:10px 0; padding-left:20px; font-size:0.9em;">';

                for(var resName in dropCounts) {
                    var data = dropCounts[resName];
                    var avgQty = data.count > 0 ? (data.totalQty / data.count).toFixed(1) : 0;
                    html += '<li>' + escapeHtml(resName) + ': ' + data.count + ' —Ä–∞–∑ (—Å—Ä–µ–¥–Ω–µ–µ ' + avgQty + ' —à—Ç.)</li>';
                }

                html += '</ul></div></div>';
                resultsContainer.innerHTML = html;
            }

            function copyChestToClipboard() {
                var name = appData.chestConfig.name || '–°—É–Ω–¥—É–∫';
                var price = appData.chestConfig.price;

                var text = name + ' ($' + price.toFixed(2) + ')\n';

                // Calculate EV
                var ev = 0;
                appData.chestConfig.items.forEach(function(item) {
                    if(!item.resourceId) return;
                    var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                    if(!res) return;
                    var avgQty = item.isRandom ? ((item.minQty || 0) + (item.maxQty || 0)) / 2 : (item.minQty || 0);
                    var dropChance = (item.dropChance || 0) / 100;
                    ev += res.price * avgQty * dropChance;
                });

                var roi = price > 0 ? ((ev - price) / price) * 100 : 0;
                text += 'Expected Value: $' + ev.toFixed(2) + '\n';
                text += 'ROI: ' + Math.max(0, roi).toFixed(0) + '%\n\n';
                text += '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:\n';

                appData.chestConfig.items.forEach(function(item) {
                    if(!item.resourceId) return;
                    var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                    if(!res) return;

                    var qtyText = item.isRandom ? item.minQty + '-' + item.maxQty + ' —à—Ç.' : item.minQty + ' —à—Ç.';
                    var rarityText = item.rarity ? ', —Ä–µ–¥–∫–æ—Å—Ç—å ' + item.rarity : '';
                    text += '‚Ä¢ ' + res.name + ': ' + qtyText + ', —à–∞–Ω—Å ' + item.dropChance + '%' + rarityText + '\n';
                });

                navigator.clipboard.writeText(text).then(function() {
                    var btn = document.getElementById('btnCopyChest');
                    var originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    btn.style.background = 'var(--success)';
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(function(err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å:\n\n' + text);
                });
            }

            function addChestToHistory() {
                var price = appData.chestConfig.price;
                if(price <= 0) return;

                // Calculate EV
                var ev = 0;
                appData.chestConfig.items.forEach(function(item) {
                    if(!item.resourceId) return;
                    var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                    if(!res) return;
                    var avgQty = item.isRandom ? ((item.minQty || 0) + (item.maxQty || 0)) / 2 : (item.minQty || 0);
                    var dropChance = (item.dropChance || 0) / 100;
                    ev += res.price * avgQty * dropChance;
                });

                var roi = price > 0 ? ((ev - price) / price) * 100 : 0;
                var discount = ev > 0 ? (1 - (price / ev)) * 100 : 0;
                var multi = Math.max(1, Math.round((ev - price) / price));

                // Build composition string
                var comp = [];
                appData.chestConfig.items.forEach(function(item) {
                    if(!item.resourceId) return;
                    var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                    if(!res) return;
                    var qtyText = item.isRandom ? item.minQty + '-' + item.maxQty : item.minQty;
                    comp.push(qtyText + ' ' + res.name + ' (' + item.dropChance + '%)');
                });

                var item = {
                    id: Date.now(),
                    name: appData.chestConfig.name || '–°—É–Ω–¥—É–∫ #' + (appData.history.length + 1),
                    price: price,
                    base: ev,
                    comp: 'üì¶ ' + comp.join(', '),
                    roi: roi,
                    disc: discount,
                    multi: multi,
                    type: 'chest'
                };

                appData.history.unshift(item);
                safeSave();
                renderHistory();

                var btn = document.getElementById('btnCompareChest');
                var originalText = btn.innerHTML;
                btn.innerHTML = '‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ!';
                btn.style.background = 'var(--success)';
                setTimeout(function() {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }

            function setChestCalcMode(mode) {
                appData.calcMode = mode;

                var normalBtn = document.getElementById('chestModeNormal');
                var reverseBtn = document.getElementById('chestModeReverse');
                var reverseSection = document.getElementById('chestReverseSection');

                if(mode === 'normal') {
                    normalBtn.classList.add('active');
                    reverseBtn.classList.remove('active');
                    reverseSection.style.display = 'none';
                } else {
                    normalBtn.classList.remove('active');
                    reverseBtn.classList.add('active');
                    reverseSection.style.display = 'block';
                    updateChestReverseMode();
                }

                safeSave();
            }

            function onChestTargetMultiChange() {
                var multi = parseFloat(document.getElementById('chestTargetMulti').value) || 1;
                var roi = multi * 100;
                document.getElementById('chestTargetROI').value = roi.toFixed(0);
                var discount = (roi / (100 + roi)) * 100;
                document.getElementById('chestTargetDiscount').value = discount.toFixed(1);
                updateChestReverseMode();
            }

            function onChestTargetROIChange() {
                var roi = parseFloat(document.getElementById('chestTargetROI').value) || 0;
                var multi = Math.round(roi / 100);
                if(multi < 1) multi = 1;
                document.getElementById('chestTargetMulti').value = multi;
                var discount = (roi / (100 + roi)) * 100;
                document.getElementById('chestTargetDiscount').value = discount.toFixed(1);
                updateChestReverseMode();
            }

            function onChestTargetDiscountChange() {
                var discount = parseFloat(document.getElementById('chestTargetDiscount').value) || 0;
                if(discount >= 100) discount = 99.9;
                var roi = (discount / (100 - discount)) * 100;
                document.getElementById('chestTargetROI').value = roi.toFixed(0);
                var multi = Math.round(roi / 100);
                if(multi < 1) multi = 1;
                document.getElementById('chestTargetMulti').value = multi;
                updateChestReverseMode();
            }

            function updateChestReverseMode(currentEV, currentPrice) {
                if(appData.calcMode !== 'reverse') return;

                var price = currentPrice || parseFloat(document.getElementById('chestPrice').value) || 0;
                var targetROI = parseFloat(document.getElementById('chestTargetROI').value) || 0;

                var profitRatio = targetROI / 100;
                var requiredEV = price * (1 + profitRatio);

                document.getElementById('chestTargetValue').innerText = '$' + requiredEV.toFixed(2);

                // Calculate current EV if not provided
                if(currentEV === undefined) {
                    currentEV = 0;
                    appData.chestConfig.items.forEach(function(item) {
                        if(!item.resourceId) return;
                        var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                        if(!res) return;
                        var avgQty = item.isRandom ? ((item.minQty || 0) + (item.maxQty || 0)) / 2 : (item.minQty || 0);
                        var dropChance = (item.dropChance || 0) / 100;
                        currentEV += res.price * avgQty * dropChance;
                    });
                }

                var remaining = requiredEV - currentEV;
                var recommendationDiv = document.getElementById('chestRecommendation');

                if(remaining > 0) {
                    recommendationDiv.innerHTML = 'üí° <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong><br>' +
                        '–¢–µ–∫—É—â–∞—è EV: $' + currentEV.toFixed(2) + '<br>' +
                        '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: <span style="color:var(--danger); font-weight:bold;">$' + remaining.toFixed(2) + '</span><br>' +
                        '–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–ª–∏ —É–≤–µ–ª–∏—á—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ/—à–∞–Ω—Å—ã –¥—Ä–æ–ø–∞.';
                } else {
                    recommendationDiv.innerHTML = '‚úì <strong style="color:var(--success);">–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</strong><br>' +
                        '–¢–µ–∫—É—â–∞—è EV: $' + currentEV.toFixed(2) + '<br>' +
                        '–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: <span style="color:var(--success); font-weight:bold;">$' + Math.abs(remaining).toFixed(2) + '</span>';
                }
            }

            // --- REVERSE MODE ---
            function setCalcMode(mode) {
                appData.calcMode = mode;

                // Update button states
                if(mode === 'normal') {
                    document.getElementById('modeNormal').classList.add('active');
                    document.getElementById('modeReverse').classList.remove('active');
                    document.getElementById('reverseSection').style.display = 'none';
                    document.getElementById('progressContainer').style.display = 'none';
                } else {
                    document.getElementById('modeNormal').classList.remove('active');
                    document.getElementById('modeReverse').classList.add('active');
                    document.getElementById('reverseSection').style.display = 'block';
                    document.getElementById('progressContainer').style.display = 'block';
                    updateReverseMode();
                }

                safeSave();
                calculate();
            }

            function onTargetMultiChange() {
                var multi = parseFloat(document.getElementById('targetMulti').value) || 1;
                // Convert multiplier to ROI
                var roi = multi * 100;
                document.getElementById('targetROI').value = roi.toFixed(0);

                // Convert ROI to Discount: Discount = ROI / (100 + ROI) * 100
                var discount = (roi / (100 + roi)) * 100;
                document.getElementById('targetDiscount').value = discount.toFixed(1);

                updateReverseMode();
            }

            function onTargetROIChange() {
                var roi = parseFloat(document.getElementById('targetROI').value) || 0;
                // Convert ROI to multiplier
                var multi = Math.round(roi / 100);
                if(multi < 1) multi = 1;
                document.getElementById('targetMulti').value = multi;

                // Convert ROI to Discount: Discount = ROI / (100 + ROI) * 100
                var discount = (roi / (100 + roi)) * 100;
                document.getElementById('targetDiscount').value = discount.toFixed(1);

                updateReverseMode();
            }

            function onTargetDiscountChange() {
                var discount = parseFloat(document.getElementById('targetDiscount').value) || 0;
                if(discount >= 100) discount = 99.9; // Limit to prevent division by zero

                // Convert Discount to ROI: ROI = Discount / (100 - Discount) * 100
                var roi = (discount / (100 - discount)) * 100;
                document.getElementById('targetROI').value = roi.toFixed(0);

                // Convert ROI to multiplier
                var multi = Math.round(roi / 100);
                if(multi < 1) multi = 1;
                document.getElementById('targetMulti').value = multi;

                updateReverseMode();
            }

            function updateReverseMode() {
                if(appData.calcMode !== 'reverse') return;

                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                var targetROI = parseFloat(document.getElementById('targetROI').value) || 0;

                // Calculate required base value using ROI directly (not rounded multiplier)
                // ROI = profitRatio * 100
                // profitRatio = (base - price) / price
                // So: base = price * (1 + ROI / 100)
                var profitRatio = targetROI / 100;
                var requiredBase = price * (1 + profitRatio);

                document.getElementById('targetBaseValue').innerText = '$' + requiredBase.toFixed(2);

                // Update progress bar
                updateProgressBar(requiredBase);
            }

            function updateProgressBar(targetBase) {
                // Calculate current base value
                var baseValue = 0;
                var inputs = document.querySelectorAll('#dynamicInputs .calc-input');
                inputs.forEach(function(inp) {
                    var count = parseFloat(inp.value) || 0;
                    var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                    if(res) baseValue += count * res.price;
                });

                var cb = document.getElementById('cb_noads');
                if(cb && cb.checked) {
                    var na = appData.resources.find(function(r){ return r.id === 'noads' });
                    if(na) baseValue += na.price;
                }

                var remaining = targetBase - baseValue;
                var percent = targetBase > 0 ? (baseValue / targetBase) * 100 : 0;
                percent = Math.min(percent, 100);

                var progressFill = document.getElementById('progressFill');
                var progressText = document.getElementById('progressText');

                progressFill.style.width = percent + '%';
                document.getElementById('progressPercent').innerText = percent.toFixed(0) + '%';
                document.getElementById('progressTargetVal').innerText = '$' + targetBase.toFixed(2);
                document.getElementById('progressCurrentVal').innerText = '$' + baseValue.toFixed(2);

                // Update fill color and text based on progress
                progressFill.className = 'progress-bar-fill';
                if(percent >= 100) {
                    progressFill.classList.add('complete');
                    progressText.innerText = '‚úì –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!';
                    document.getElementById('progressRemainingDiv').innerHTML =
                        '<span style="color:var(--success);">‚úì –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: <span id="progressRemainingVal">$' +
                        Math.abs(remaining).toFixed(2) + '</span></span>';
                    if(percent > 100) {
                        progressFill.classList.remove('complete');
                        progressFill.classList.add('over');
                    }
                } else {
                    progressText.innerText = percent.toFixed(0) + '%';
                    document.getElementById('progressRemainingDiv').innerHTML =
                        '–û—Å—Ç–∞–ª–æ—Å—å: <span id="progressRemainingVal" style="color:var(--danger); font-weight:bold;">$' +
                        remaining.toFixed(2) + '</span>';
                }
            }

            // --- COPY TO CLIPBOARD ---
            function copyResultToClipboard() {
                var name = document.getElementById('offerName').value || 'Offer';
                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                var base = document.getElementById('resBase').innerText;
                var multi = document.getElementById('resMulti').innerText;
                var roi = document.getElementById('resRoi').innerText;
                var disc = document.getElementById('resDisc').innerText;

                // Collect composition
                var comps = [];
                document.querySelectorAll('#dynamicInputs .calc-input').forEach(function(inp) {
                    var val = parseFloat(inp.value);
                    if(val > 0) {
                        var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                        if(res) comps.push(val + ' ' + res.name);
                    }
                });
                if(document.getElementById('cb_noads').checked) comps.push("No Ads");

                // Format text: "Name ($price): composition. Value: $base (Xx) | ROI% | Discount%"
                var composition = comps.length > 0 ? comps.join(', ') : 'empty';
                var text = name + ' ($' + price.toFixed(2) + '): ' + composition +
                           '. Value: ' + base + ' (' + multi + ') | ROI: ' + roi + ' | Discount: ' + disc;

                // Copy to clipboard
                navigator.clipboard.writeText(text).then(function() {
                    // Show feedback
                    var btn = document.getElementById('btnCopyResult');
                    var originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì Copied!';
                    btn.style.background = 'var(--success)';

                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(function(err) {
                    // Fallback for older browsers
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:\n\n' + text);
                });
            }

            // --- HISTORY ---
            function addToHistory() {
                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                var baseText = document.getElementById('resBase').innerText;
                var base = parseFloat(baseText.replace('$',''));
                if(price <= 0) return;

                var comps = [];
                document.querySelectorAll('#dynamicInputs .calc-input').forEach(function(inp) {
                    var val = parseFloat(inp.value);
                    if(val > 0) {
                        var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                        if(res) comps.push(val + ' ' + res.name);
                    }
                });
                if(document.getElementById('cb_noads').checked) comps.push("No Ads");

                var profitRatio = (base - price) / price;
                var item = {
                    id: Date.now(),
                    name: document.getElementById('offerName').value || 'Offer #' + (appData.history.length + 1),
                    price: price,
                    base: base,
                    comp: comps.join(', '),
                    roi: profitRatio * 100,
                    disc: (1-(price/base))*100,
                    multi: Math.max(1, Math.round(profitRatio))
                };
                appData.history.unshift(item);
                safeSave();
                renderHistory();
            }

            function renderHistory() {
                var tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';
                appData.history.forEach(function(h, idx) {
                    var cls = 'text-ok';
                    if(h.roi < 0) cls = 'text-bad';
                    if(h.roi >= 100) cls = 'text-good';
                    if(h.roi >= 250) cls = 'text-epic';
                    if(h.roi >= 500) cls = 'text-legendary';

                    var tr = document.createElement('tr');
                    tr.innerHTML = 
                        '<td><strong>' + escapeHtml(h.name) + '</strong></td>' +
                        '<td>$' + h.price.toFixed(2) + '</td>' +
                        '<td style="font-size:0.85em; color:#ccc;">' + escapeHtml(h.comp) + '</td>' +
                        '<td>$' + h.base.toFixed(2) + '</td>' +
                        '<td>' + Math.max(0, h.disc).toFixed(0) + '%</td>' +
                        '<td class="' + cls + '" style="font-weight:bold">' + Math.max(0, h.roi).toFixed(0) + '%</td>' +
                        '<td>' + h.multi + 'x</td>' +
                        '<td><button class="btn-danger btn-icon btn-del-hist">√ó</button></td>';
                    
                    tr.querySelector('.btn-del-hist').addEventListener('click', function() { delHistory(idx); });
                    tbody.appendChild(tr);
                });
            }

            function delHistory(idx) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                    appData.history.splice(idx, 1);
                    safeSave();
                    renderHistory();
                }
            }
            
            function clearHistory() {
                if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) {
                    appData.history = [];
                    safeSave();
                    renderHistory();
                }
            }

            // --- SETTINGS ---
            function openResourceSettings() {
                var list = document.getElementById('resourceListEditor');
                list.innerHTML = '';
                appData.resources.forEach(function(res, idx) {
                    var div = document.createElement('div');
                    div.className = 'checklist-item';
                    div.innerHTML = 
                        '<div style="flex-grow:1">' +
                            '<input type="text" class="edit-name" value="' + escapeHtml(res.name) + '" style="width:110px; margin-right:5px;">' +
                            '<input type="number" class="edit-price" value="' + res.price + '" step="0.0001" style="width:120px;">' +
                        '</div>' +
                        (!res.isSpecial ? '<button class="btn-danger btn-icon btn-del-res">‚úñ</button>' : '');
                    
                    div.querySelector('.edit-name').addEventListener('change', function(e) { updateResVal(idx, 'name', e.target.value); });
                    div.querySelector('.edit-price').addEventListener('change', function(e) { updateResVal(idx, 'price', e.target.value); });
                    var delBtn = div.querySelector('.btn-del-res');
                    if(delBtn) delBtn.addEventListener('click', function() { delRes(idx); });

                    list.appendChild(div);
                });
                document.getElementById('modalResources').classList.add('open');
            }

            function updateResVal(idx, field, val) {
                if (field === 'price') val = parseFloat(val);
                appData.resources[idx][field] = val;
                safeSave();
                updateNoAdsLabel();

                // Call appropriate function based on current tab
                if(appData.currentTab === 'chest') {
                    calculateChest();
                } else if(appData.currentTab === 'chain') {
                    renderChainSlots();
                } else {
                    renderInputs();
                    calculate();
                }
            }

            function addNewResource() {
                var name = document.getElementById('newResName').value;
                var price = parseFloat(document.getElementById('newResPrice').value);
                if(name && !isNaN(price)) {
                    var id = 'usr_' + Date.now();
                    appData.resources.push({ id: id, name: name, price: price });
                    appData.tabConfig['custom'].push(id);
                    safeSave();
                    openResourceSettings();
                    renderInputs();
                    document.getElementById('newResName').value = '';
                }
            }

            function delRes(idx) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                    var id = appData.resources[idx].id;
                    appData.resources.splice(idx, 1);
                    for(var tab in appData.tabConfig) {
                        appData.tabConfig[tab] = appData.tabConfig[tab].filter(function(x) { return x !== id });
                    }
                    safeSave();
                    openResourceSettings();
                    renderInputs();
                    calculate();
                }
            }

            function openTabConfig() {
                var list = document.getElementById('tabFieldList');
                list.innerHTML = '';
                var currentActive = appData.tabConfig[appData.currentTab] || [];
                
                appData.resources.forEach(function(res) {
                    if(res.isSpecial) return; 
                    var isChecked = currentActive.includes(res.id) ? 'checked' : '';
                    var div = document.createElement('div');
                    div.className = 'checklist-item';
                    div.innerHTML = '<span>' + escapeHtml(res.name) + '</span>' +
                        '<input type="checkbox" class="cfg-cb" value="' + res.id + '" ' + isChecked + ' style="width:20px; height:20px;">';
                    list.appendChild(div);
                });
                document.getElementById('modalTabConfig').classList.add('open');
            }

            function saveTabConfig() {
                var checkboxes = document.querySelectorAll('.cfg-cb');
                var newConfig = [];
                checkboxes.forEach(function(cb) { if(cb.checked) newConfig.push(cb.value); });
                appData.tabConfig[appData.currentTab] = newConfig;
                safeSave();
                closeModal('modalTabConfig');
                renderInputs();
                calculate();
            }

            function closeModal(id) { document.getElementById(id).classList.remove('open'); }
            
            function resetDefaults() {
                if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?")) {
                    appData.resources = JSON.parse(JSON.stringify(defaultResources));
                    appData.tabConfig = JSON.parse(JSON.stringify(defaultTabConfig));
                    safeSave();
                    location.reload();
                }
            }

            // --- UTILS ---
            function escapeHtml(text) {
                if (!text) return text;
                return text.replace(/[&<>"']/g, function(m) {
                    var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
                    return map[m];
                });
            }
            
            function updateNoAdsLabel() {
                var res = appData.resources.find(function(r){ return r.id === 'noads' });
                var label = document.getElementById('lbl_noads_price');
                if(res && label) label.innerText = res.price;
            }

            function exportData() {
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
                var node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "gemini_data.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
            }

            function importData(input) {
                var file = input.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        appData = JSON.parse(e.target.result);
                        safeSave();
                        location.reload();
                    } catch(err) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞"); }
                };
                reader.readAsText(file);
            }

            // Run
            init();
        });
    </script>
</body>
</html>