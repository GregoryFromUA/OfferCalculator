<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Offer Calculator v7.6 - Chain Offers</title>
    <style>
        :root {
            --primary: #6200ea;
            --primary-hover: #5000c2;
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-2: #2c2c2c;
            --text: #ffffff;
            --text-sec: #b0b0b0;
            --danger: #cf6679;
            --success: #4caf50;
            --warning: #ff9800;
            --border: #444;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Layout */
        .main-wrapper {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
        }

        @media (max-width: 850px) {
            .main-wrapper { grid-template-columns: 1fr; }
        }

        .card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        /* Controls */
        h3 { margin: 0 0 15px 0; }
        
        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: bold;
            transition: 0.2s;
            font-size: 0.9em;
            color: white;
            background: #333;
        }
        button:hover { opacity: 0.9; }
        
        .btn-primary { background: var(--primary); width: 100%; padding: 12px; font-size: 1em; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-icon { padding: 5px 10px; }
        .btn-danger { background: var(--danger); }
        .btn-sec { background: var(--surface-2); border: 1px solid var(--border); }

        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 5px;
        }
        input:focus { outline: none; border-color: var(--primary); background: #333; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1200px;
        }

        .tab-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-sec);
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.2s;
            font-weight: bold;
            flex-grow: 1;
            text-align: center;
        }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Inputs */
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: var(--text-sec); font-size: 0.85em; }
        
        /* Price Buttons */
        .price-presets {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .price-tag {
            background: #333;
            padding: 10px 5px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            border: 1px solid transparent;
            text-align: center;
            user-select: none;
        }
        .price-tag:hover { border-color: var(--secondary); color: var(--secondary); background: #444; }
        .price-tag:active { transform: scale(0.95); }

        /* Result */
        .result-card { position: sticky; top: 20px; text-align: center; border: 2px solid transparent; }
        .result-main { font-size: 3.5em; font-weight: 800; margin: 10px 0; line-height: 1; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8em; text-transform: uppercase; margin-bottom: 5px; }
        .res-row { display: flex; justify-content: space-between; padding: 12px 0; border-top: 1px solid #444; }

        /* History */
        .history-container { width: 100%; max-width: 1200px; overflow-x: auto; margin-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 8px; min-width: 800px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; font-size: 0.9em; }
        th { background: #252525; color: var(--text-sec); }
        tr:hover { background: #2c2c2c; }

        /* Modals */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; display: none; justify-content: center; align-items: center; }
        .overlay.open { display: flex; }
        .modal { background: var(--surface); padding: 25px; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .checklist-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; }
        
        /* Colors */
        .val-bad { border-color: var(--danger); }
        .val-bad .result-main, .text-bad { color: var(--danger); }
        .val-bad .badge { background: var(--danger); color: white; }
        .val-ok { border-color: var(--warning); }
        .val-ok .result-main, .text-ok { color: var(--warning); }
        .val-ok .badge { background: var(--warning); color: black; }
        .val-good { border-color: var(--success); }
        .val-good .result-main, .text-good { color: var(--success); }
        .val-good .badge { background: var(--success); color: white; }
        .val-epic { border-color: #00e5ff; }
        .val-epic .result-main, .text-epic { color: #00e5ff; }
        .val-epic .badge { background: #00e5ff; color: black; }
        .val-legendary { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); }
        .val-legendary .result-main, .text-legendary { color: #ffd700; }
        .val-legendary .badge { background: #ffd700; color: black; }

        .tools-bar { width: 100%; max-width: 1200px; display: flex; justify-content: space-between; margin-bottom: 10px; }
        .tools-bar a { color: var(--text-sec); text-decoration: underline; font-size: 0.9em; cursor: pointer; margin-right: 15px; }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 5px;
            background: var(--surface-2);
            padding: 3px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .mode-toggle button {
            flex: 1;
            padding: 8px 16px;
            background: transparent;
            color: var(--text-sec);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .mode-toggle button.active {
            background: var(--primary);
            color: white;
        }

        /* Reverse Mode */
        .reverse-section {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }
        .reverse-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .reverse-fields { grid-template-columns: 1fr; }
        }

        /* Progress Bar */
        .progress-container {
            margin-top: 15px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .progress-bar-bg {
            width: 100%;
            height: 30px;
            background: var(--surface-2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s ease, background 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }
        .progress-bar-fill.complete {
            background: linear-gradient(90deg, var(--success), #00e5ff);
        }
        .progress-bar-fill.over {
            background: linear-gradient(90deg, #ffd700, #ff9800);
        }
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .progress-target {
            color: var(--text-sec);
        }
        .progress-current {
            font-weight: bold;
            color: var(--primary);
        }
        .progress-remaining {
            color: var(--warning);
        }

        /* Chain Offer Styles */
        .chain-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .slot-card {
            background: var(--surface-2);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            position: relative;
            transition: 0.2s;
        }
        .slot-card:hover {
            border-color: var(--primary);
        }
        .slot-card.free-slot {
            border-left: 4px solid var(--success);
        }
        .slot-card.paid-slot {
            border-left: 4px solid var(--warning);
        }
        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .slot-type-toggle {
            display: flex;
            gap: 5px;
            background: var(--surface);
            padding: 3px;
            border-radius: 6px;
        }
        .slot-type-toggle button {
            padding: 6px 12px;
            background: transparent;
            color: var(--text-sec);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: 0.2s;
        }
        .slot-type-toggle button.active {
            background: var(--primary);
            color: white;
        }
        .slot-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .slot-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .slot-item select, .slot-item input {
            background: var(--surface);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .slot-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
            background: var(--surface);
            border-radius: 6px;
            font-size: 0.85em;
        }
        .slot-metric {
            text-align: center;
        }
        .slot-metric-label {
            color: var(--text-sec);
            font-size: 0.8em;
            margin-bottom: 3px;
        }
        .slot-metric-value {
            font-weight: bold;
            color: var(--primary);
        }
        .btn-delete-slot {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: white;
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            transition: 0.2s;
        }
        .btn-delete-slot:hover {
            transform: scale(1.15);
            background: #d32f2f;
        }
        .chain-result-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--primary);
        }
        .chain-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        .chain-summary-item {
            padding: 15px;
            background: var(--surface-2);
            border-radius: 8px;
            text-align: center;
        }
        .chain-summary-label {
            color: var(--text-sec);
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .chain-summary-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary);
        }
    </style>
</head>
<body>

    <!-- Tools -->
    <div class="tools-bar">
        <div>
            <a id="btnOpenRes">‚öô –†–µ—Å—É—Ä—Å—ã –∏ –¶–µ–Ω—ã</a>
            <a id="btnExport">üíæ –≠–∫—Å–ø–æ—Ä—Ç</a>
            <a id="btnImportTrigger">üìÇ –ò–º–ø–æ—Ä—Ç</a>
            <input type="file" id="importFile" style="display:none">
        </div>
        <div>v7.6 Chain Offers</div>
    </div>

    <!-- Tabs (No Onclick Here!) -->
    <div class="tabs" id="tabsContainer">
        <div class="tab-btn active" data-tab="pack" id="tab_pack">Pack</div>
        <div class="tab-btn" data-tab="chest" id="tab_chest">Chests</div>
        <div class="tab-btn" data-tab="blitz" id="tab_blitz">Blitz</div>
        <div class="tab-btn" data-tab="chain" id="tab_chain">‚õì Chain</div>
        <div class="tab-btn" data-tab="custom" id="tab_custom">Custom (All)</div>
    </div>

    <div class="main-wrapper" id="mainWrapper">
        <!-- Left: Config -->
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="tabTitle">Pack Config</h3>
                <button class="btn-sec btn-icon" id="btnOpenTabConfig">‚úè –ü–æ–ª—è</button>
            </div>

            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button id="modeNormal" class="active">üìä –û–±—ã—á–Ω—ã–π</button>
                <button id="modeReverse">üéØ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
            </div>

            <div class="input-group" style="margin-bottom: 20px;">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –û—Ñ–µ—Ä–∞</label>
                <input type="text" id="offerName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            </div>

            <!-- Reverse Mode Section -->
            <div class="reverse-section" id="reverseSection" style="display:none;">
                <label style="font-weight:bold; color:var(--warning); display:block; margin-bottom:10px;">üéØ –¶–ï–õ–ï–í–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò</label>
                <div class="reverse-fields">
                    <div class="input-group">
                        <label>Multiplier (X)</label>
                        <input type="number" id="targetMulti" placeholder="5" min="1" step="1" value="5">
                    </div>
                    <div class="input-group">
                        <label>ROI %</label>
                        <input type="number" id="targetROI" placeholder="400" min="0" step="1" value="400">
                    </div>
                    <div class="input-group">
                        <label>Discount %</label>
                        <input type="number" id="targetDiscount" placeholder="80" min="0" max="99" step="1" value="80">
                    </div>
                </div>
                <div style="margin-top:10px; padding:10px; background:#1a1a1a; border-radius:6px; text-align:center;">
                    <div style="font-size:0.85em; color:var(--text-sec);">–¢—Ä–µ–±—É–µ–º–∞—è –±–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</div>
                    <div style="font-size:1.8em; font-weight:bold; color:var(--warning); margin-top:5px;" id="targetBaseValue">$0.00</div>
                </div>
            </div>
            
            <div id="dynamicInputs" class="input-grid"></div>

            <div style="margin-top: 15px; padding-top:10px; border-top: 1px solid #333;">
                <label style="display:flex; align-items:center; cursor:pointer; gap: 10px;">
                    <input type="checkbox" id="cb_noads" style="width:20px; height:20px;">
                    <span style="font-weight:bold;">NO ADS</span>
                    <span style="color:#666; font-size:0.9em;">(Base: +$<span id="lbl_noads_price">10</span>)</span>
                </label>
            </div>

            <!-- Progress Bar (Reverse Mode) -->
            <div class="progress-container" id="progressContainer" style="display:none;">
                <div style="font-weight:bold; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span>üìà –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±–æ—Ä–∫–∏</span>
                    <span id="progressPercent" style="color:var(--warning);">0%</span>
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressFill" style="width:0%;">
                        <span id="progressText"></span>
                    </div>
                </div>
                <div class="progress-info">
                    <div class="progress-target">
                        –¶–µ–ª—å: <span id="progressTargetVal" style="font-weight:bold;">$0.00</span>
                    </div>
                    <div class="progress-current">
                        –¢–µ–∫—É—â–∞—è: <span id="progressCurrentVal">$0.00</span>
                    </div>
                    <div class="progress-remaining" id="progressRemainingDiv">
                        –û—Å—Ç–∞–ª–æ—Å—å: <span id="progressRemainingVal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Price Section -->
            <div style="margin-top: 25px; background: #252525; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <label style="color: var(--secondary); font-weight: bold; display:block; margin-bottom:5px;">–¶–ï–ù–ê –ü–ê–ö–ê ($)</label>
                
                <input type="number" id="offerPrice" step="0.5" min="0.49" value="0.99" style="font-size: 1.4em; font-weight: bold; color: var(--warning);">
                
                <!-- Price Presets (No Onclick!) -->
                <div class="price-presets" id="pricePresetsContainer">
                    <div class="price-tag" data-val="0.99">$0.99</div>
                    <div class="price-tag" data-val="1.99">$1.99</div>
                    <div class="price-tag" data-val="2.99">$2.99</div>
                    <div class="price-tag" data-val="3.99">$3.99</div>
                    <div class="price-tag" data-val="4.99">$4.99</div>
                    <div class="price-tag" data-val="7.99">$7.99</div>
                    <div class="price-tag" data-val="9.99">$9.99</div>
                    <div class="price-tag" data-val="14.99">$14.99</div>
                    <div class="price-tag" data-val="19.99">$19.99</div>
                    <div class="price-tag" data-val="24.99">$24.99</div>
                </div>
            </div>
        </div>

        <!-- Right: Result -->
        <div class="card result-card val-ok" id="resCard">
            <div class="badge" id="resBadge">Ready</div>
            <div style="color: #888; font-size: 0.9em; margin-top:5px;">Multiplier (X Value)</div>
            <div class="result-main" id="resMulti">0x</div>
            <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 15px;">
                <span id="resRoi">0%</span> MORE
            </div>
            <div class="res-row">
                <span>Base Value</span>
                <span id="resBase" style="font-weight:bold; font-size:1.2em;">$0.00</span>
            </div>
            <div class="res-row">
                <span>Discount</span>
                <span id="resDisc" style="font-weight:bold;">0%</span>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" id="btnCopyResult">üìã Copy</button>
                <button class="btn-primary" id="btnAddToHistory">‚¨á –°—Ä–∞–≤–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- History -->
    <div class="history-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</h3>
            <button class="btn-sec btn-icon" id="btnClearHistory">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <table id="historyTable">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–°–æ—Å—Ç–∞–≤</th>
                    <th>Base Value</th>
                    <th>Discount</th>
                    <th>ROI</th>
                    <th>Multiplier</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>

    <!-- Modals -->
    <div class="overlay" id="modalResources">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>–ë–∞–∑–æ–≤—ã–µ –¶–µ–Ω—ã</h3>
                <button class="btn-icon" id="btnCloseResModal">‚úñ</button>
            </div>
            <div id="resourceListEditor"></div>
            <div style="margin-top:20px; padding-top:10px; border-top:1px solid #444;">
                <h4>–ù–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å</h4>
                <input type="text" id="newResName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin-bottom:5px;">
                <input type="number" id="newResPrice" placeholder="–¶–µ–Ω–∞ ($)" step="0.01" style="margin-bottom:10px;">
                <button class="btn-primary" id="btnAddNewRes">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button class="btn-sec" id="btnResetDefaults" style="margin-top:10px; width:100%;">–°–±—Ä–æ—Å –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É</button>
            </div>
        </div>
    </div>

    <div class="overlay" id="modalTabConfig">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>–ü–æ–ª—è –≤–∫–ª–∞–¥–∫–∏</h3>
                <button class="btn-icon" id="btnCloseTabModal">‚úñ</button>
            </div>
            <div id="tabFieldList"></div>
            <button class="btn-primary" style="margin-top:15px;" id="btnSaveTabConfig">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- CONFIGURATION ---
            var defaultResources = [
                { id: 'gem', name: 'Gem', price: 0.0125 },
                { id: 'skip', name: 'SkipIt', price: 0.3 },
                { id: 'tnt', name: 'TNT', price: 0.06 },
                { id: 'nitro', name: 'Nitro', price: 0.03 },
                { id: 's_chest', name: 'Small Chest', price: 0.75 },
                { id: 'b_chest', name: 'Big Chest', price: 3.75 },
                { id: 'noads', name: 'No Ads', price: 10.0, isSpecial: true } 
            ];

            var defaultTabConfig = {
                'pack': ['gem', 'skip'],
                'chest': ['s_chest', 'b_chest', 'skip'],
                'blitz': ['tnt', 'nitro'],
                'chain': [], // Chain tab uses different UI
                'custom': ['gem', 'skip', 'tnt', 'nitro', 's_chest', 'b_chest']
            };

            var appData = {
                resources: JSON.parse(JSON.stringify(defaultResources)),
                tabConfig: JSON.parse(JSON.stringify(defaultTabConfig)),
                history: [],
                currentTab: 'pack',
                calcMode: 'normal', // 'normal' or 'reverse'
                chainSlots: [] // Array of slot objects for chain tab
            };

            // Store original mainWrapper HTML for restoration
            var originalMainWrapperHTML = '';

            // --- INITIALIZATION ---

            function init() {
                // Save original HTML before any modifications
                originalMainWrapperHTML = document.getElementById('mainWrapper').innerHTML;

                safeLoad();
                switchTab(appData.currentTab);
                updateNoAdsLabel();
                renderHistory();
                bindEvents();

                // Restore calc mode
                if(appData.calcMode === 'reverse') {
                    setCalcMode('reverse');
                }
            }

            function bindEvents() {
                // Top Bar
                document.getElementById('btnOpenRes').addEventListener('click', openResourceSettings);
                document.getElementById('btnExport').addEventListener('click', exportData);
                document.getElementById('btnImportTrigger').addEventListener('click', function() { document.getElementById('importFile').click(); });
                document.getElementById('importFile').addEventListener('change', function() { importData(this); });

                // Mode Toggle (only for normal tabs)
                var modeNormal = document.getElementById('modeNormal');
                var modeReverse = document.getElementById('modeReverse');
                if(modeNormal) modeNormal.addEventListener('click', function() { setCalcMode('normal'); });
                if(modeReverse) modeReverse.addEventListener('click', function() { setCalcMode('reverse'); });

                // Reverse Mode Inputs (only for normal tabs)
                var targetMulti = document.getElementById('targetMulti');
                var targetROI = document.getElementById('targetROI');
                var targetDiscount = document.getElementById('targetDiscount');
                if(targetMulti) targetMulti.addEventListener('input', onTargetMultiChange);
                if(targetROI) targetROI.addEventListener('input', onTargetROIChange);
                if(targetDiscount) targetDiscount.addEventListener('input', onTargetDiscountChange);

                // Tabs
                document.querySelectorAll('.tab-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var tab = this.getAttribute('data-tab');
                        switchTab(tab);
                    });
                });

                // Config Buttons (only for normal tabs)
                var btnOpenTabConfig = document.getElementById('btnOpenTabConfig');
                var cb_noads = document.getElementById('cb_noads');
                var offerPrice = document.getElementById('offerPrice');
                if(btnOpenTabConfig) btnOpenTabConfig.addEventListener('click', openTabConfig);
                if(cb_noads) cb_noads.addEventListener('change', calculate);
                if(offerPrice) offerPrice.addEventListener('input', calculate);

                // Price Presets (only for normal tabs)
                var pricePresetsContainer = document.getElementById('pricePresetsContainer');
                if(pricePresetsContainer) {
                    pricePresetsContainer.addEventListener('click', function(e) {
                        if(e.target.classList.contains('price-tag')) {
                            var val = e.target.getAttribute('data-val');
                            var offerPriceInput = document.getElementById('offerPrice');
                            if(offerPriceInput) {
                                offerPriceInput.value = val;
                                calculate();
                            }
                        }
                    });
                }

                // Result & History (only for normal tabs)
                var btnCopyResult = document.getElementById('btnCopyResult');
                var btnAddToHistory = document.getElementById('btnAddToHistory');
                var btnClearHistory = document.getElementById('btnClearHistory');
                if(btnCopyResult) btnCopyResult.addEventListener('click', copyResultToClipboard);
                if(btnAddToHistory) btnAddToHistory.addEventListener('click', addToHistory);
                if(btnClearHistory) btnClearHistory.addEventListener('click', clearHistory);

                // Modals
                document.getElementById('btnCloseResModal').addEventListener('click', function() { closeModal('modalResources'); });
                document.getElementById('btnCloseTabModal').addEventListener('click', function() { closeModal('modalTabConfig'); });
                
                document.getElementById('btnAddNewRes').addEventListener('click', addNewResource);
                document.getElementById('btnResetDefaults').addEventListener('click', resetDefaults);
                document.getElementById('btnSaveTabConfig').addEventListener('click', saveTabConfig);
            }

            // --- STORAGE ---
            function safeSave() {
                try { localStorage.setItem('gemini_calc_v6', JSON.stringify(appData)); } catch(e) {}
            }
            function safeLoad() {
                try {
                    var saved = localStorage.getItem('gemini_calc_v6');
                    if (saved) {
                        appData = JSON.parse(saved);
                        if(!appData.resources) appData.resources = JSON.parse(JSON.stringify(defaultResources));
                        if(!appData.calcMode) appData.calcMode = 'normal'; // Default to normal mode
                        if(!appData.chainSlots) appData.chainSlots = []; // Default to empty chain
                    }
                } catch(e) {}
            }

            // --- CORE ---
            function switchTab(tabName) {
                appData.currentTab = tabName;
                document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
                var activeBtn = document.getElementById('tab_' + tabName);
                if(activeBtn) activeBtn.classList.add('active');
                safeSave();

                // Check if Chain tab
                if(tabName === 'chain') {
                    renderChainUI();
                } else {
                    renderNormalUI();
                    renderInputs();
                    calculate();
                }
            }

            function renderInputs() {
                var container = document.getElementById('dynamicInputs');
                if(!container) return; // Skip if on Chain tab or element doesn't exist
                container.innerHTML = '';
                var activeFields = appData.tabConfig[appData.currentTab] || [];
                
                activeFields.forEach(function(resId) {
                    var res = appData.resources.find(function(r){ return r.id === resId });
                    if (!res || res.isSpecial) return; 
                    
                    var div = document.createElement('div');
                    div.className = 'input-group';
                    div.innerHTML = '<label>' + escapeHtml(res.name) + '</label>' +
                                    '<input type="number" class="calc-input" data-id="' + res.id + '" placeholder="0">';
                    
                    var inp = div.querySelector('input');
                    inp.addEventListener('input', calculate);
                    container.appendChild(div);
                });
            }

            function calculate() {
                var baseValue = 0;
                var inputs = document.querySelectorAll('#dynamicInputs .calc-input');
                inputs.forEach(function(inp) {
                    var count = parseFloat(inp.value) || 0;
                    var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                    if(res) baseValue += count * res.price;
                });

                var cb = document.getElementById('cb_noads');
                if(cb && cb.checked) {
                    var na = appData.resources.find(function(r){ return r.id === 'noads' });
                    if(na) baseValue += na.price;
                }

                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                
                var multi = 0;
                var roi = 0;
                var disc = 0;

                if (price > 0 && baseValue > 0) {
                    var profitRatio = (baseValue - price) / price;
                    multi = Math.max(1, Math.round(profitRatio));
                    roi = profitRatio * 100;
                    disc = (1 - (price / baseValue)) * 100;
                }

                document.getElementById('resBase').innerText = '$' + baseValue.toFixed(2);
                document.getElementById('resMulti').innerText = multi + "x"; 
                document.getElementById('resRoi').innerText = Math.max(0, roi).toFixed(0) + '%';
                document.getElementById('resDisc').innerText = Math.max(0, disc).toFixed(0) + '%';

                var card = document.getElementById('resCard');
                var badge = document.getElementById('resBadge');
                card.className = 'card result-card';
                
                if(price <= 0 || baseValue <= 0) {
                    card.classList.add('val-ok'); badge.innerText = "–í–≤–µ–¥–∏ –¥–∞–Ω–Ω—ã–µ";
                } else if (roi < 0) {
                    card.classList.add('val-bad'); badge.innerText = "Bad Deal";
                } else if (roi < 100) {
                    card.classList.add('val-ok'); badge.innerText = "Normal";
                } else if (roi < 250) {
                    card.classList.add('val-good'); badge.innerText = "Good";
                } else if (roi < 500) {
                    card.classList.add('val-epic'); badge.innerText = "Epic";
                } else {
                    card.classList.add('val-legendary'); badge.innerText = "Legendary";
                }

                // Update reverse mode if active
                if(appData.calcMode === 'reverse') {
                    updateReverseMode();
                }
            }

            // --- CHAIN MODE ---
            function renderNormalUI() {
                var wrapper = document.getElementById('mainWrapper');

                // Check if normal UI exists, if not restore from saved HTML
                if(!document.getElementById('dynamicInputs')) {
                    wrapper.innerHTML = originalMainWrapperHTML;

                    // Re-bind events for normal tab elements after restoration
                    var btnOpenTabConfig = document.getElementById('btnOpenTabConfig');
                    var cb_noads = document.getElementById('cb_noads');
                    var offerPrice = document.getElementById('offerPrice');
                    if(btnOpenTabConfig) btnOpenTabConfig.addEventListener('click', openTabConfig);
                    if(cb_noads) cb_noads.addEventListener('change', calculate);
                    if(offerPrice) offerPrice.addEventListener('input', calculate);

                    var pricePresetsContainer = document.getElementById('pricePresetsContainer');
                    if(pricePresetsContainer) {
                        pricePresetsContainer.addEventListener('click', function(e) {
                            if(e.target.classList.contains('price-tag')) {
                                var val = e.target.getAttribute('data-val');
                                var offerPriceInput = document.getElementById('offerPrice');
                                if(offerPriceInput) {
                                    offerPriceInput.value = val;
                                    calculate();
                                }
                            }
                        });
                    }

                    var btnCopyResult = document.getElementById('btnCopyResult');
                    var btnAddToHistory = document.getElementById('btnAddToHistory');
                    if(btnCopyResult) btnCopyResult.addEventListener('click', copyResultToClipboard);
                    if(btnAddToHistory) btnAddToHistory.addEventListener('click', addToHistory);

                    var modeNormal = document.getElementById('modeNormal');
                    var modeReverse = document.getElementById('modeReverse');
                    if(modeNormal) modeNormal.addEventListener('click', function() { setCalcMode('normal'); });
                    if(modeReverse) modeReverse.addEventListener('click', function() { setCalcMode('reverse'); });

                    var targetMulti = document.getElementById('targetMulti');
                    var targetROI = document.getElementById('targetROI');
                    var targetDiscount = document.getElementById('targetDiscount');
                    if(targetMulti) targetMulti.addEventListener('input', onTargetMultiChange);
                    if(targetROI) targetROI.addEventListener('input', onTargetROIChange);
                    if(targetDiscount) targetDiscount.addEventListener('input', onTargetDiscountChange);
                }
            }

            function renderChainUI() {
                var wrapper = document.getElementById('mainWrapper');

                // Build Chain UI
                wrapper.innerHTML = '';

                // Left column: Slots list
                var leftCard = document.createElement('div');
                leftCard.className = 'card';
                leftCard.style.gridColumn = '1';
                leftCard.innerHTML = '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">' +
                    '<h3>‚õì Chain Slots</h3>' +
                    '<button class="btn-primary btn-icon" id="btnAddSlot">+ Add Slot</button>' +
                    '</div>' +
                    '<div id="chainSlotsContainer" class="chain-container"></div>';

                // Right column: Results
                var rightCard = document.createElement('div');
                rightCard.className = 'card chain-result-card';
                rightCard.innerHTML = '<h3 style="text-align:center; margin-bottom:20px;">Chain Summary</h3>' +
                    '<div class="chain-summary">' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Total Slots</div><div class="chain-summary-value" id="chainTotalSlots">0</div></div>' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Total Spent</div><div class="chain-summary-value" id="chainTotalSpent">$0.00</div></div>' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Cumulative Value</div><div class="chain-summary-value" id="chainCumulativeValue">$0.00</div></div>' +
                    '<div class="chain-summary-item"><div class="chain-summary-label">Average ROI</div><div class="chain-summary-value" id="chainAvgROI">0%</div></div>' +
                    '</div>' +
                    '<button class="btn-primary" style="margin-top:20px; width:100%;" id="btnCopyChain">üìã Copy Chain</button>';

                wrapper.appendChild(leftCard);
                wrapper.appendChild(rightCard);

                // Bind events
                document.getElementById('btnAddSlot').addEventListener('click', addChainSlot);
                document.getElementById('btnCopyChain').addEventListener('click', copyChainToClipboard);

                // Render existing slots
                renderChainSlots();
            }

            function renderChainSlots() {
                var container = document.getElementById('chainSlotsContainer');
                if(!container) return;

                container.innerHTML = '';

                if(appData.chainSlots.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-sec);">No slots yet. Click "Add Slot" to start building your chain.</div>';
                    updateChainResults();
                    return;
                }

                appData.chainSlots.forEach(function(slot, index) {
                    var slotCard = createSlotCard(slot, index);
                    container.appendChild(slotCard);
                });

                updateChainResults();
            }

            function createSlotCard(slot, index) {
                var card = document.createElement('div');
                card.className = 'slot-card ' + (slot.type === 'free' ? 'free-slot' : 'paid-slot');

                var html = '<div class="slot-header">' +
                    '<div><strong>Slot ' + (index + 1) + '</strong></div>' +
                    '<div class="slot-type-toggle">' +
                    '<button class="slot-type-btn ' + (slot.type === 'free' ? 'active' : '') + '" data-type="free" data-index="' + index + '">Free</button>' +
                    '<button class="slot-type-btn ' + (slot.type === 'paid' ? 'active' : '') + '" data-type="paid" data-index="' + index + '">Paid</button>' +
                    '</div>' +
                    '</div>';

                // Price for paid slots
                if(slot.type === 'paid') {
                    html += '<div style="margin-bottom:15px;"><label style="display:block; margin-bottom:5px; color:var(--text-sec); font-size:0.9em;">Slot Price ($)</label>' +
                        '<input type="number" class="slot-price-input" data-index="' + index + '" value="' + (slot.price || 0) + '" step="0.01" min="0" style="width:100%;"></div>';
                }

                // Items (up to 3)
                html += '<div class="slot-items">';
                for(var i = 0; i < 3; i++) {
                    var item = slot.items[i] || { resourceId: '', count: 0 };
                    html += '<div class="slot-item">' +
                        '<select class="slot-res-select" data-index="' + index + '" data-item="' + i + '">' +
                        '<option value="">---</option>';

                    appData.resources.forEach(function(res) {
                        if(res.isSpecial) return;
                        var selected = item.resourceId === res.id ? 'selected' : '';
                        html += '<option value="' + res.id + '" ' + selected + '>' + escapeHtml(res.name) + '</option>';
                    });

                    html += '</select>' +
                        '<input type="number" class="slot-item-count" data-index="' + index + '" data-item="' + i + '" value="' + item.count + '" min="0" placeholder="Count">' +
                        '</div>';
                }
                html += '</div>';

                // Metrics
                var metrics = calculateSlotMetrics(slot, index);
                html += '<div class="slot-metrics">' +
                    '<div class="slot-metric"><div class="slot-metric-label">Base Value</div><div class="slot-metric-value">$' + metrics.baseValue.toFixed(2) + '</div></div>';

                if(slot.type === 'paid') {
                    html += '<div class="slot-metric"><div class="slot-metric-label">Discount</div><div class="slot-metric-value">' + metrics.discount.toFixed(0) + '%</div></div>';
                } else {
                    html += '<div class="slot-metric"><div class="slot-metric-label">Free Item %</div><div class="slot-metric-value">' + metrics.freeItemPercent.toFixed(1) + '%</div></div>';
                }

                html += '<div class="slot-metric"><div class="slot-metric-label">Cumul. Value</div><div class="slot-metric-value">$' + metrics.cumulativeValue.toFixed(2) + '</div></div>' +
                    '<div class="slot-metric"><div class="slot-metric-label">Total Spent</div><div class="slot-metric-value">$' + metrics.totalSpent.toFixed(2) + '</div></div>' +
                    '</div>';

                // Delete button
                html += '<button class="btn-delete-slot" data-index="' + index + '">√ó</button>';

                card.innerHTML = html;

                // Bind events
                card.querySelectorAll('.slot-type-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        changeSlotType(parseInt(this.getAttribute('data-index')), this.getAttribute('data-type'));
                    });
                });

                var priceInput = card.querySelector('.slot-price-input');
                if(priceInput) {
                    priceInput.addEventListener('input', function() {
                        updateSlotPrice(parseInt(this.getAttribute('data-index')), parseFloat(this.value) || 0);
                    });
                }

                card.querySelectorAll('.slot-res-select').forEach(function(sel) {
                    sel.addEventListener('change', function() {
                        updateSlotItem(parseInt(this.getAttribute('data-index')), parseInt(this.getAttribute('data-item')), 'resourceId', this.value);
                    });
                });

                card.querySelectorAll('.slot-item-count').forEach(function(inp) {
                    inp.addEventListener('input', function() {
                        updateSlotItem(parseInt(this.getAttribute('data-index')), parseInt(this.getAttribute('data-item')), 'count', parseFloat(this.value) || 0);
                    });
                });

                card.querySelector('.btn-delete-slot').addEventListener('click', function() {
                    deleteChainSlot(parseInt(this.getAttribute('data-index')));
                });

                return card;
            }

            function addChainSlot() {
                var newSlot = {
                    type: 'free',
                    price: 0,
                    items: [
                        { resourceId: '', count: 0 },
                        { resourceId: '', count: 0 },
                        { resourceId: '', count: 0 }
                    ]
                };
                appData.chainSlots.push(newSlot);
                safeSave();
                renderChainSlots();
            }

            function deleteChainSlot(index) {
                if(confirm('Delete this slot?')) {
                    appData.chainSlots.splice(index, 1);
                    safeSave();
                    renderChainSlots();
                }
            }

            function changeSlotType(index, type) {
                appData.chainSlots[index].type = type;
                if(type === 'free') {
                    appData.chainSlots[index].price = 0;
                }
                safeSave();
                renderChainSlots();
            }

            function updateSlotPrice(index, price) {
                appData.chainSlots[index].price = price;
                safeSave();
                renderChainSlots();
            }

            function updateSlotItem(index, itemIndex, field, value) {
                appData.chainSlots[index].items[itemIndex][field] = value;
                safeSave();
                renderChainSlots();
            }

            function calculateSlotMetrics(slot, index) {
                // Calculate base value
                var baseValue = 0;
                slot.items.forEach(function(item) {
                    if(item.resourceId) {
                        var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                        if(res) baseValue += item.count * res.price;
                    }
                });

                // Calculate cumulative and total spent up to this slot
                var cumulativeValue = 0;
                var totalSpent = 0;
                for(var i = 0; i <= index; i++) {
                    var s = appData.chainSlots[i];
                    s.items.forEach(function(item) {
                        if(item.resourceId) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) cumulativeValue += item.count * res.price;
                        }
                    });
                    if(s.type === 'paid') {
                        totalSpent += s.price || 0;
                    }
                }

                // Calculate discount for paid slots
                var discount = 0;
                if(slot.type === 'paid' && slot.price > 0 && baseValue > 0) {
                    discount = (1 - (slot.price / baseValue)) * 100;
                }

                // Calculate free item % for free slots
                var freeItemPercent = 0;
                if(slot.type === 'free' && totalSpent > 0) {
                    freeItemPercent = (baseValue / totalSpent) * 100;
                }

                return {
                    baseValue: baseValue,
                    discount: discount,
                    freeItemPercent: freeItemPercent,
                    cumulativeValue: cumulativeValue,
                    totalSpent: totalSpent
                };
            }

            function updateChainResults() {
                var totalSlots = appData.chainSlots.length;
                var totalSpent = 0;
                var cumulativeValue = 0;

                appData.chainSlots.forEach(function(slot) {
                    slot.items.forEach(function(item) {
                        if(item.resourceId) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) cumulativeValue += item.count * res.price;
                        }
                    });
                    if(slot.type === 'paid') {
                        totalSpent += slot.price || 0;
                    }
                });

                var avgROI = 0;
                if(totalSpent > 0) {
                    avgROI = ((cumulativeValue - totalSpent) / totalSpent) * 100;
                }

                document.getElementById('chainTotalSlots').innerText = totalSlots;
                document.getElementById('chainTotalSpent').innerText = '$' + totalSpent.toFixed(2);
                document.getElementById('chainCumulativeValue').innerText = '$' + cumulativeValue.toFixed(2);
                document.getElementById('chainAvgROI').innerText = avgROI.toFixed(0) + '%';
            }

            function copyChainToClipboard() {
                var text = 'Chain Offer (' + appData.chainSlots.length + ' slots):\n';

                appData.chainSlots.forEach(function(slot, index) {
                    var metrics = calculateSlotMetrics(slot, index);
                    var items = [];
                    slot.items.forEach(function(item) {
                        if(item.resourceId && item.count > 0) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) items.push(item.count + ' ' + res.name);
                        }
                    });

                    var slotText = '- Slot ' + (index + 1) + ' (' + (slot.type === 'free' ? 'Free' : 'Paid $' + slot.price.toFixed(2)) + '): ' +
                        (items.length > 0 ? items.join(', ') : 'empty') +
                        ' | Value: $' + metrics.baseValue.toFixed(2);

                    if(slot.type === 'paid') {
                        slotText += ' (' + metrics.discount.toFixed(0) + '% OFF)';
                    }

                    text += slotText + '\n';
                });

                var totalSpent = 0;
                var cumulativeValue = 0;
                appData.chainSlots.forEach(function(slot) {
                    var metrics = calculateSlotMetrics(slot, appData.chainSlots.indexOf(slot));
                    if(slot.type === 'paid') totalSpent += slot.price || 0;
                });
                appData.chainSlots.forEach(function(slot) {
                    slot.items.forEach(function(item) {
                        if(item.resourceId) {
                            var res = appData.resources.find(function(r) { return r.id === item.resourceId });
                            if(res) cumulativeValue += item.count * res.price;
                        }
                    });
                });

                var avgROI = totalSpent > 0 ? ((cumulativeValue - totalSpent) / totalSpent) * 100 : 0;
                text += '\nTotal: $' + totalSpent.toFixed(2) + ' ‚Üí $' + cumulativeValue.toFixed(2) + ' | Average ROI: ' + avgROI.toFixed(0) + '%';

                navigator.clipboard.writeText(text).then(function() {
                    var btn = document.getElementById('btnCopyChain');
                    var originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì Copied!';
                    btn.style.background = 'var(--success)';
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(function(err) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:\n\n' + text);
                });
            }

            // --- REVERSE MODE ---
            function setCalcMode(mode) {
                appData.calcMode = mode;

                // Update button states
                if(mode === 'normal') {
                    document.getElementById('modeNormal').classList.add('active');
                    document.getElementById('modeReverse').classList.remove('active');
                    document.getElementById('reverseSection').style.display = 'none';
                    document.getElementById('progressContainer').style.display = 'none';
                } else {
                    document.getElementById('modeNormal').classList.remove('active');
                    document.getElementById('modeReverse').classList.add('active');
                    document.getElementById('reverseSection').style.display = 'block';
                    document.getElementById('progressContainer').style.display = 'block';
                    updateReverseMode();
                }

                safeSave();
                calculate();
            }

            function onTargetMultiChange() {
                var multi = parseFloat(document.getElementById('targetMulti').value) || 1;
                // Convert multiplier to ROI
                var roi = multi * 100;
                document.getElementById('targetROI').value = roi.toFixed(0);

                // Convert ROI to Discount: Discount = ROI / (100 + ROI) * 100
                var discount = (roi / (100 + roi)) * 100;
                document.getElementById('targetDiscount').value = discount.toFixed(1);

                updateReverseMode();
            }

            function onTargetROIChange() {
                var roi = parseFloat(document.getElementById('targetROI').value) || 0;
                // Convert ROI to multiplier
                var multi = Math.round(roi / 100);
                if(multi < 1) multi = 1;
                document.getElementById('targetMulti').value = multi;

                // Convert ROI to Discount: Discount = ROI / (100 + ROI) * 100
                var discount = (roi / (100 + roi)) * 100;
                document.getElementById('targetDiscount').value = discount.toFixed(1);

                updateReverseMode();
            }

            function onTargetDiscountChange() {
                var discount = parseFloat(document.getElementById('targetDiscount').value) || 0;
                if(discount >= 100) discount = 99.9; // Limit to prevent division by zero

                // Convert Discount to ROI: ROI = Discount / (100 - Discount) * 100
                var roi = (discount / (100 - discount)) * 100;
                document.getElementById('targetROI').value = roi.toFixed(0);

                // Convert ROI to multiplier
                var multi = Math.round(roi / 100);
                if(multi < 1) multi = 1;
                document.getElementById('targetMulti').value = multi;

                updateReverseMode();
            }

            function updateReverseMode() {
                if(appData.calcMode !== 'reverse') return;

                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                var targetROI = parseFloat(document.getElementById('targetROI').value) || 0;

                // Calculate required base value using ROI directly (not rounded multiplier)
                // ROI = profitRatio * 100
                // profitRatio = (base - price) / price
                // So: base = price * (1 + ROI / 100)
                var profitRatio = targetROI / 100;
                var requiredBase = price * (1 + profitRatio);

                document.getElementById('targetBaseValue').innerText = '$' + requiredBase.toFixed(2);

                // Update progress bar
                updateProgressBar(requiredBase);
            }

            function updateProgressBar(targetBase) {
                // Calculate current base value
                var baseValue = 0;
                var inputs = document.querySelectorAll('#dynamicInputs .calc-input');
                inputs.forEach(function(inp) {
                    var count = parseFloat(inp.value) || 0;
                    var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                    if(res) baseValue += count * res.price;
                });

                var cb = document.getElementById('cb_noads');
                if(cb && cb.checked) {
                    var na = appData.resources.find(function(r){ return r.id === 'noads' });
                    if(na) baseValue += na.price;
                }

                var remaining = targetBase - baseValue;
                var percent = targetBase > 0 ? (baseValue / targetBase) * 100 : 0;
                percent = Math.min(percent, 100);

                var progressFill = document.getElementById('progressFill');
                var progressText = document.getElementById('progressText');

                progressFill.style.width = percent + '%';
                document.getElementById('progressPercent').innerText = percent.toFixed(0) + '%';
                document.getElementById('progressTargetVal').innerText = '$' + targetBase.toFixed(2);
                document.getElementById('progressCurrentVal').innerText = '$' + baseValue.toFixed(2);

                // Update fill color and text based on progress
                progressFill.className = 'progress-bar-fill';
                if(percent >= 100) {
                    progressFill.classList.add('complete');
                    progressText.innerText = '‚úì –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!';
                    document.getElementById('progressRemainingDiv').innerHTML =
                        '<span style="color:var(--success);">‚úì –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ: <span id="progressRemainingVal">$' +
                        Math.abs(remaining).toFixed(2) + '</span></span>';
                    if(percent > 100) {
                        progressFill.classList.remove('complete');
                        progressFill.classList.add('over');
                    }
                } else {
                    progressText.innerText = percent.toFixed(0) + '%';
                    document.getElementById('progressRemainingDiv').innerHTML =
                        '–û—Å—Ç–∞–ª–æ—Å—å: <span id="progressRemainingVal" style="color:var(--danger); font-weight:bold;">$' +
                        remaining.toFixed(2) + '</span>';
                }
            }

            // --- COPY TO CLIPBOARD ---
            function copyResultToClipboard() {
                var name = document.getElementById('offerName').value || 'Offer';
                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                var base = document.getElementById('resBase').innerText;
                var multi = document.getElementById('resMulti').innerText;
                var roi = document.getElementById('resRoi').innerText;
                var disc = document.getElementById('resDisc').innerText;

                // Collect composition
                var comps = [];
                document.querySelectorAll('#dynamicInputs .calc-input').forEach(function(inp) {
                    var val = parseFloat(inp.value);
                    if(val > 0) {
                        var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                        if(res) comps.push(val + ' ' + res.name);
                    }
                });
                if(document.getElementById('cb_noads').checked) comps.push("No Ads");

                // Format text: "Name ($price): composition. Value: $base (Xx) | ROI% | Discount%"
                var composition = comps.length > 0 ? comps.join(', ') : 'empty';
                var text = name + ' ($' + price.toFixed(2) + '): ' + composition +
                           '. Value: ' + base + ' (' + multi + ') | ROI: ' + roi + ' | Discount: ' + disc;

                // Copy to clipboard
                navigator.clipboard.writeText(text).then(function() {
                    // Show feedback
                    var btn = document.getElementById('btnCopyResult');
                    var originalText = btn.innerHTML;
                    btn.innerHTML = '‚úì Copied!';
                    btn.style.background = 'var(--success)';

                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(function(err) {
                    // Fallback for older browsers
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:\n\n' + text);
                });
            }

            // --- HISTORY ---
            function addToHistory() {
                var price = parseFloat(document.getElementById('offerPrice').value) || 0;
                var baseText = document.getElementById('resBase').innerText;
                var base = parseFloat(baseText.replace('$',''));
                if(price <= 0) return;

                var comps = [];
                document.querySelectorAll('#dynamicInputs .calc-input').forEach(function(inp) {
                    var val = parseFloat(inp.value);
                    if(val > 0) {
                        var res = appData.resources.find(function(r){ return r.id === inp.getAttribute('data-id') });
                        if(res) comps.push(val + ' ' + res.name);
                    }
                });
                if(document.getElementById('cb_noads').checked) comps.push("No Ads");

                var profitRatio = (base - price) / price;
                var item = {
                    id: Date.now(),
                    name: document.getElementById('offerName').value || 'Offer #' + (appData.history.length + 1),
                    price: price,
                    base: base,
                    comp: comps.join(', '),
                    roi: profitRatio * 100,
                    disc: (1-(price/base))*100,
                    multi: Math.max(1, Math.round(profitRatio))
                };
                appData.history.unshift(item);
                safeSave();
                renderHistory();
            }

            function renderHistory() {
                var tbody = document.getElementById('historyBody');
                tbody.innerHTML = '';
                appData.history.forEach(function(h, idx) {
                    var cls = 'text-ok';
                    if(h.roi < 0) cls = 'text-bad';
                    if(h.roi >= 100) cls = 'text-good';
                    if(h.roi >= 250) cls = 'text-epic';
                    if(h.roi >= 500) cls = 'text-legendary';

                    var tr = document.createElement('tr');
                    tr.innerHTML = 
                        '<td><strong>' + escapeHtml(h.name) + '</strong></td>' +
                        '<td>$' + h.price.toFixed(2) + '</td>' +
                        '<td style="font-size:0.85em; color:#ccc;">' + escapeHtml(h.comp) + '</td>' +
                        '<td>$' + h.base.toFixed(2) + '</td>' +
                        '<td>' + Math.max(0, h.disc).toFixed(0) + '%</td>' +
                        '<td class="' + cls + '" style="font-weight:bold">' + Math.max(0, h.roi).toFixed(0) + '%</td>' +
                        '<td>' + h.multi + 'x</td>' +
                        '<td><button class="btn-danger btn-icon btn-del-hist">√ó</button></td>';
                    
                    tr.querySelector('.btn-del-hist').addEventListener('click', function() { delHistory(idx); });
                    tbody.appendChild(tr);
                });
            }

            function delHistory(idx) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                    appData.history.splice(idx, 1);
                    safeSave();
                    renderHistory();
                }
            }
            
            function clearHistory() {
                if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?")) {
                    appData.history = [];
                    safeSave();
                    renderHistory();
                }
            }

            // --- SETTINGS ---
            function openResourceSettings() {
                var list = document.getElementById('resourceListEditor');
                list.innerHTML = '';
                appData.resources.forEach(function(res, idx) {
                    var div = document.createElement('div');
                    div.className = 'checklist-item';
                    div.innerHTML = 
                        '<div style="flex-grow:1">' +
                            '<input type="text" class="edit-name" value="' + escapeHtml(res.name) + '" style="width:110px; margin-right:5px;">' +
                            '<input type="number" class="edit-price" value="' + res.price + '" step="0.0001" style="width:120px;">' +
                        '</div>' +
                        (!res.isSpecial ? '<button class="btn-danger btn-icon btn-del-res">‚úñ</button>' : '');
                    
                    div.querySelector('.edit-name').addEventListener('change', function(e) { updateResVal(idx, 'name', e.target.value); });
                    div.querySelector('.edit-price').addEventListener('change', function(e) { updateResVal(idx, 'price', e.target.value); });
                    var delBtn = div.querySelector('.btn-del-res');
                    if(delBtn) delBtn.addEventListener('click', function() { delRes(idx); });

                    list.appendChild(div);
                });
                document.getElementById('modalResources').classList.add('open');
            }

            function updateResVal(idx, field, val) {
                if (field === 'price') val = parseFloat(val);
                appData.resources[idx][field] = val;
                safeSave();
                updateNoAdsLabel();
                renderInputs();
                calculate();
            }

            function addNewResource() {
                var name = document.getElementById('newResName').value;
                var price = parseFloat(document.getElementById('newResPrice').value);
                if(name && !isNaN(price)) {
                    var id = 'usr_' + Date.now();
                    appData.resources.push({ id: id, name: name, price: price });
                    appData.tabConfig['custom'].push(id);
                    safeSave();
                    openResourceSettings();
                    renderInputs();
                    document.getElementById('newResName').value = '';
                }
            }

            function delRes(idx) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å?")) {
                    var id = appData.resources[idx].id;
                    appData.resources.splice(idx, 1);
                    for(var tab in appData.tabConfig) {
                        appData.tabConfig[tab] = appData.tabConfig[tab].filter(function(x) { return x !== id });
                    }
                    safeSave();
                    openResourceSettings();
                    renderInputs();
                    calculate();
                }
            }

            function openTabConfig() {
                var list = document.getElementById('tabFieldList');
                list.innerHTML = '';
                var currentActive = appData.tabConfig[appData.currentTab] || [];
                
                appData.resources.forEach(function(res) {
                    if(res.isSpecial) return; 
                    var isChecked = currentActive.includes(res.id) ? 'checked' : '';
                    var div = document.createElement('div');
                    div.className = 'checklist-item';
                    div.innerHTML = '<span>' + escapeHtml(res.name) + '</span>' +
                        '<input type="checkbox" class="cfg-cb" value="' + res.id + '" ' + isChecked + ' style="width:20px; height:20px;">';
                    list.appendChild(div);
                });
                document.getElementById('modalTabConfig').classList.add('open');
            }

            function saveTabConfig() {
                var checkboxes = document.querySelectorAll('.cfg-cb');
                var newConfig = [];
                checkboxes.forEach(function(cb) { if(cb.checked) newConfig.push(cb.value); });
                appData.tabConfig[appData.currentTab] = newConfig;
                safeSave();
                closeModal('modalTabConfig');
                renderInputs();
                calculate();
            }

            function closeModal(id) { document.getElementById(id).classList.remove('open'); }
            
            function resetDefaults() {
                if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏?")) {
                    appData.resources = JSON.parse(JSON.stringify(defaultResources));
                    appData.tabConfig = JSON.parse(JSON.stringify(defaultTabConfig));
                    safeSave();
                    location.reload();
                }
            }

            // --- UTILS ---
            function escapeHtml(text) {
                if (!text) return text;
                return text.replace(/[&<>"']/g, function(m) {
                    var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
                    return map[m];
                });
            }
            
            function updateNoAdsLabel() {
                var res = appData.resources.find(function(r){ return r.id === 'noads' });
                var label = document.getElementById('lbl_noads_price');
                if(res && label) label.innerText = res.price;
            }

            function exportData() {
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
                var node = document.createElement('a');
                node.setAttribute("href", dataStr);
                node.setAttribute("download", "gemini_data.json");
                document.body.appendChild(node);
                node.click();
                node.remove();
            }

            function importData(input) {
                var file = input.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        appData = JSON.parse(e.target.result);
                        safeSave();
                        location.reload();
                    } catch(err) { alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞"); }
                };
                reader.readAsText(file);
            }

            // Run
            init();
        });
    </script>
</body>
</html>